<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Football Crazy - A Karrier</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="leagues.js" defer></script>
    <script src="nationalities.js" defer></script>
    <script src="players.js" defer></script> 
    <script src="names.js" defer></script>
</head>
<body>

    <div class="loading-screen" id="loadingScreen">
        <svg class="football-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ffffff" d="M256 512c141.4 0 256-114.6 256-256S397.4 0 256 0S0 114.6 0 256S114.6 512 256 512zM152 352h32v32c0 17.7-14.3 32-32 32s-32-14.3-32-32V320c0-17.7 14.3-32 32-32h64c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V352H152zM280 288c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32H280zm64-224c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32h64c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32H344zM120 96c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32s32-14.3 32-32V128c0-17.7-14.3-32-32-32zm88 64c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32h64c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32H208z"/></svg>
        <h1 class="loading-title">Football Crazy</h1>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
    </div>

    <div class="main-menu-container hidden" id="mainMenu">
        <h1 class="menu-title">Football Crazy</h1>
        <div class="menu-buttons">
            <button class="button next-btn" id="newGameBtn">Új Karrier</button>
        </div>
        <div id="saveSlotsContainer" class="save-slots-container">
            <!-- Mentési helyek dinamikusan generálva -->
        </div>
    </div>

    <div class="character-creator-container hidden" id="characterCreator">
        <div class="form-carousel" id="formCarousel">
            <div class="form-step">
                <h2>Add meg a neved</h2>
                <p class="form-description">Ez a név fog megjelenni a mezeken és a sajtóban.</p>
                <input type="text" id="playerName" placeholder="pl. Minta János" required>
                <div class="navigation-buttons" style="justify-content: flex-end;"><button class="button next-btn">Tovább &rarr;</button></div>
            </div>
            <div class="form-step">
                <h2>Válaszd ki a nemzetiséged</h2>
                <p class="form-description">Melyik országot képviseled a nemzetközi porondon?</p>
                <div class="custom-select-wrapper">
                    <div class="select-button" id="nationalitySelect">
                        <div class="selected-option" data-value="hu"><img src="https://flagcdn.com/w40/hu.png" alt="Magyar zászló"><span>Magyar</span></div><span>&#9660;</span>
                    </div>
                    <div class="select-options hidden" id="nationalityOptions">
                        <!-- Options are generated from nationalities.js -->
                    </div>
                </div>
                <div class="navigation-buttons"><button class="button prev-btn">&larr; Vissza</button><button class="button next-btn">Tovább &rarr;</button></div>
            </div>
            <div class="form-step">
                <h2>Válaszd ki a bajnokságot</h2>
                <p class="form-description">Válassz egy bajnokságot, ahol elindítod a karriered.</p>
                <div class="league-select-grid" id="leagueSelectGrid">
                    <!-- Dinamikusan generálva JS-ből -->
                </div>
                <div class="navigation-buttons"><button class="button prev-btn">&larr; Vissza</button><button class="button next-btn">Tovább &rarr;</button></div>
            </div>
            <div class="form-step">
                <h2>Aláírnád a szerződést?</h2>
                <p style="text-align: center; color: var(--text-muted);">Válassz a két felajánlott csapat közül, és indítsd el a karriered!</p>
                <div class="contract-offers-container" id="contractOffersContainer">
                    <!-- Ajánlatok generálása JS-ből -->
                </div>
                <div class="navigation-buttons" style="justify-content: flex-start;"><button class="button prev-btn">&larr; Vissza</button></div>
            </div>
        </div>
    </div>
    
    <div class="overlay hidden" id="matchResultOverlay">
        <div class="card">
            <div class="match-result-header">
                <div class="match-result-team">
                    <img id="resultHomeLogo" src="" alt="Hazai csapat logó">
                    <h3 id="resultHomeName">Hazai</h3>
                </div>
                <div class="match-result-score" id="resultScore">0 - 0</div>
                <div class="match-result-team">
                    <img id="resultAwayLogo" src="" alt="Vendég csapat logó">
                    <h3 id="resultAwayName">Vendég</h3>
                </div>
            </div>
            <div class="match-summary">
                <h4>Teljesítményed</h4>
                <p id="resultPlayerPerformance">Gólok: 0, Gólpasszok: 0</p>
                <h4>Jutalom</h4>
                <p id="resultEarnings">Fizetés: €0, Bónusz: €0</p>
            </div>
            <button class="button continue-btn" id="matchResultContinueBtn">Tovább</button>
        </div>
    </div>

    <div class="overlay hidden" id="offerModalOverlay">
        <div class="card" id="offerModalCard">
            <!-- Tartalom dinamikusan generálva JS-ből -->
        </div>
    </div>
    
    <div class="overlay hidden" id="playerSwapModalOverlay">
        <div class="card" id="playerSwapModalCard">
             <!-- Tartalom dinamikusan generálva JS-ből -->
        </div>
    </div>

    <div id="matchSimulatorOverlay" class="overlay hidden">
        <div class="simulator-container">
            <div class="sim-header">
                <div class="sim-team sim-team-home">
                    <span id="simHomeName">Hazai</span>
                </div>
                <div class="sim-score-time">
                    <span id="simScore">0 - 0</span>
                    <span id="simTime">00:00</span>
                </div>
                <div class="sim-team sim-team-away">
                    <span id="simAwayName">Vendég</span>
                </div>
            </div>
            <div id="commentary-timeline" class="commentary-timeline"></div>
            <div id="pitch-enter-banner" class="pitch-enter-banner hidden">
                <i class="fas fa-running"></i>
                <span id="bannerPlayerName"></span> is on the pitch!
            </div>
            <div id="half-time-banner" class="pitch-enter-banner hidden">
                <i class="fas fa-coffee"></i>
                <span>Félidő</span>
            </div>
        </div>
        <button id="sim-pause-btn" class="sim-pause-btn"><i class="fas fa-pause"></i></button>
    </div>

    <div class="overlay hidden" id="matchGameOverlay">
        <div class="game-scoreboard-wrapper">
            <div id="game-scoreboard" class="game-scoreboard">
                <div class="team-info left">
                    <span id="gameHomeName">HOM</span>
                </div>
                <div class="score-info">
                    <div id="gameScore">0 - 0</div>
                    <div class="score-timeline">
                        <span id="homeProgress"></span>
                        <span id="awayProgress"></span>
                    </div>
                </div>
                <div class="team-info right">
                    <span id="gameAwayName">AWY</span>
                </div>
                <div id="gameTime" style="display:none;">00:00</div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="mobile-controls">
            <div id="joystick-zone" class="joystick-zone">
                <div id="joystick-handle" class="joystick-handle"></div>
            </div>
            <div class="action-buttons">
                <button id="pass-btn" class="action-btn pass-btn">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Passz</span>
                </button>
                <button id="shoot-btn" class="action-btn shoot-btn">
                    <i class="fas fa-futbol"></i>
                    <span>Lövés</span>
                </button>
            </div>
        </div>
    </div>

    <div class="main-hub hidden" id="mainHub">
        <nav class="sidebar">
            <button class="nav-btn active" data-screen="dashboardScreen" data-tooltip="Irányítópult"><i class="fas fa-tachometer-alt"></i></button>
            <button class="nav-btn" data-screen="squadScreen" data-tooltip="Csapat"><i class="fas fa-users"></i></button>
            <button class="nav-btn" data-screen="leagueScreen" data-tooltip="Bajnokság"><i class="fas fa-trophy"></i></button>
            <button class="nav-btn" data-screen="playerTransferScreen" data-tooltip="Saját Ajánlatok"><i class="fas fa-arrows-alt-h"></i></button>
            <button class="nav-btn" data-screen="globalTransferScreen" data-tooltip="Igazolások"><i class="fas fa-globe-europe"></i></button>
        </nav>
        <div class="hub-content-wrapper">
            <header class="top-bar">
                <button id="profileBtn" class="profile-btn">
                    <i class="fas fa-user"></i> 
                    <span id="headerPlayerName">Játékos Neve</span>
                </button>
                <div class="currency-display">
                    <div class="currency-item">
                        <i class="fas fa-money-bill-wave" style="color: #2ecc71;"></i>
                        <span id="headerPlayerMoney">0</span>
                    </div>
                    <div class="currency-item">
                        <i class="fas fa-coins" style="color: #f1c40f;"></i>
                        <span id="headerPlayerCoins">0</span>
                    </div>
                </div>
            </header>
            <main class="main-content">
                <div id="dashboardScreen" class="screen">
                    <div class="dashboard-grid">
                        <div class="dashboard-card player-profile-card" id="dashboardProfileCard">
                            <div class="card-header">
                                <img id="hubPlayerTeamLogo" class="team-logo" src="" alt="Csapat Logó">
                                <div class="player-info">
                                    <h4 id="hubPlayerName">Játékos Neve</h4>
                                    <p id="hubPlayerTeamName">Csapat Neve</p>
                                </div>
                            </div>
                            <p><strong>Értékelés:</strong> <span id="hubPlayerRating">85</span></p>
                            <p><strong>Életkor:</strong> <span id="hubPlayerAge">17</span></p>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <i class="fas fa-calendar-alt"></i>
                                <h3>Következő Meccs</h3>
                            </div>
                            <p><strong>Ellenfél:</strong> <span id="hubNextOpponent">Nincs sorsolás</span></p>
                            <button class="button next-btn" style="width: 100%;" id="playMatchBtn">Meccs Indítása</button>
                        </div>
                        <div class="dashboard-card">
                            <div class="card-header">
                                <i class="fas fa-list-ol"></i>
                                <h3>Bajnokság</h3>
                            </div>
                            <p><strong>Helyezés:</strong> <span id="hubLeaguePosition">-.</span></p>
                            <p><strong>Forduló:</strong> <span id="hubMatchday">0 / 14</span></p>
                        </div>
                    </div>
                </div>
                <div id="squadScreen" class="screen hidden">
                    <div class="squad-header">
                        <h2 id="squadTeamName">Csapatom</h2>
                        <div id="formationSelector" class="formation-selector"></div>
                        <div class="squad-avg-rating">Átl. Értékelés: <span id="squadAvgRating">0</span></div>
                    </div>
                    <div class="squad-container">
                        <div class="pitch">
                            <div class="pitch-lines"></div>
                            <div class="formation" id="formation-forwards"></div>
                            <div class="formation" id="formation-midfielders"></div>
                            <div class="formation" id="formation-defenders"></div>
                            <div class="formation" id="formation-goalkeeper"></div>
                        </div>
                        <div class="squad-bench">
                            <h3>Cserék</h3>
                            <div class="bench-players" id="bench-players">
                                <!-- Bench player slots will be dynamically managed -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="leagueScreen" class="screen hidden">
                    <div class="league-header">
                        <i id="leagueNavPrev" class="fas fa-chevron-left nav-arrow"></i>
                        <h2 id="leagueTitle">Bajnoki Tabella</h2>
                        <i id="leagueNavNext" class="fas fa-chevron-right nav-arrow"></i>
                    </div>
                    <div class="stats-tabs">
                        <button class="stat-tab active" data-content="leagueTableContainer">Tabella</button>
                        <button class="stat-tab" data-content="scorersContainer">Góllövők</button>
                        <button class="stat-tab" data-content="assistsContainer">Asszisztok</button>
                    </div>

                    <div id="leagueTableContainer" class="stats-content">
                        <table class="league-table">
                            <thead>
                                <tr>
                                    <th>#</th><th>Csapat</th>
                                    <th class="hide-on-mobile">M</th><th class="hide-on-mobile">Gy</th><th class="hide-on-mobile">D</th><th class="hide-on-mobile">V</th>
                                    <th>GK</th><th>P</th>
                                </tr>
                            </thead>
                            <tbody id="leagueTableBody"></tbody>
                        </table>
                    </div>
                    <div id="scorersContainer" class="stats-content hidden">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">A góllövőlista a következő frissítésben érkezik!</p>
                    </div>
                    <div id="assistsContainer" class="stats-content hidden">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">Az asszisztlista a következő frissítésben érkezik!</p>
                    </div>
                </div>
                <div id="profileScreen" class="screen hidden profile-screen">
                    <h2 id="profilePlayerName">Játékos Profilja</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="profileGoals">0</div><div class="stat-label">Gólok</div></div>
                        <div class="stat-card"><div class="stat-value" id="profileAssists">0</div><div class="stat-label">Gólpasszok</div></div>
                        <div class="stat-card"><div class="stat-value" id="profileMatches">0</div><div class="stat-label">Játszott Meccsek</div></div>
                        <div class="stat-card"><div class="stat-value" id="profileTrophies">0</div><div class="stat-label">Trófeák</div></div>
                    </div>
                    <div class="transfer-card" style="margin-top: 25px;">
                        <h2>Képességfejlesztés</h2>
                        <p style="text-align: center; color: var(--text-muted);">Gyémántokért fejlesztheted a játékosod képességeit. A funkció a következő frissítésben érkezik!</p>
                    </div>
                </div>
                <div id="playerTransferScreen" class="screen hidden">
                    <div class="transfer-card">
                        <h2>Saját átigazolási ajánlatok</h2>
                        <div id="transferOffers">
                            <p style="text-align: center; color: var(--text-muted);">Jelenleg nincsenek ajánlatok.</p>
                        </div>
                    </div>
                </div>
                <div id="globalTransferScreen" class="screen hidden">
                    <h2>Igazolási Piac</h2>
                    <div class="transfer-filters">
                        <input type="text" id="playerNameSearch" placeholder="Játékos keresése...">
                        <select id="positionFilter">
                            <option value="">Minden poszt</option>
                            <option value="CS">Csatár (CS)</option>
                            <option value="KP">Középpályás (KP)</option>
                            <option value="V">Védő (V)</option>
                            <option value="K">Kapus (K)</option>
                        </select>
                    </div>
                    <div class="transfer-market-results" id="transferMarketResults">
                        <!-- Player cards will be generated here -->
                    </div>
                </div>
            </main>
        </div>
        <nav class="bottom-bar">
            <button class="nav-btn active" data-screen="dashboardScreen"><i class="fas fa-tachometer-alt"></i></button>
            <button class="nav-btn" data-screen="squadScreen"><i class="fas fa-users"></i></button>
            <button class="nav-btn" data-screen="leagueScreen"><i class="fas fa-trophy"></i></button>
            <button class="nav-btn" data-screen="playerTransferScreen"><i class="fas fa-arrows-alt-h"></i></button>
            <button class="nav-btn" data-screen="globalTransferScreen"><i class="fas fa-globe-europe"></i></button>
        </nav>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    let allPlayers = []; 
    const SAVE_KEY = 'footballCrazySaves';
    let gameState = {};
    let allSaves = [];
    let currentSaveId = null;

    // --- DOM ELEMEK ---
    const mainMenu = document.getElementById('mainMenu');
    const characterCreator = document.getElementById('characterCreator');
    const matchSimulatorOverlay = document.getElementById('matchSimulatorOverlay');
    const matchGameOverlay = document.getElementById('matchGameOverlay');
    const matchResultOverlay = document.getElementById('matchResultOverlay');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const allScreens = document.querySelectorAll('.screen');
    const allNavButtons = document.querySelectorAll('.nav-btn');

    // --- JÁTÉK ÁLLAPOT VÁLTOZÓK ---
    let gameLoop;
    let player, ball, opponents, teammates, keys, homeGoal;
    let currentMatchData;
    let simulationInterval;
    let miniGameActive = false;
    let isPaused = false;
    let opponentTeamColor = '#e74c3c';
    let selectedLeagueName = null;
    let selectedNationality = 'hu';
    let currentOpponentStrength = 70; 
    const PLAYER_BASE_SPEED = 3.5;
    
    let displayedCountry = null;
    let displayedLeagueName = null;

    const FORMATIONS = {
        '4-3-3': { defenders: 4, midfielders: 3, forwards: 3 },
        '4-4-2': { defenders: 4, midfielders: 4, forwards: 2 },
        '3-5-2': { defenders: 3, midfielders: 5, forwards: 2 }
    };

    // --- SEGÉDFÜGGVÉNYEK ---
    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getRandomElement(arr) {
        if (!arr || arr.length === 0) return null;
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function generatePlayerName(nationalityCode) {
        const nameData = NAMES[nationalityCode] || NAMES['en'];
        const firstName = getRandomElement(nameData.firstNames);
        const lastName = getRandomElement(nameData.lastNames);
        return `${firstName} ${lastName}`;
    }

    function formatValue(value) {
        if (value >= 1000000) return `€${(value / 1000000).toFixed(1)}M`;
        if (value >= 1000) return `€${Math.round(value / 1000)}K`;
        return `€${value}`;
    }
    
    function calculateTeamStrength() {
        if (!gameState.team || !gameState.team.lineup || !gameState.team.players) return 70;

        let totalRating = 0;
        let playerCount = 0;
        
        for (const slotId in gameState.team.lineup) {
             if (!slotId.startsWith('bench') && gameState.team.lineup[slotId]) {
                 const player = gameState.team.players.find(p => p.id === gameState.team.lineup[slotId]);
                 if(player) {
                     totalRating += player.rating;
                     playerCount++;
                 }
             }
        }
        
        if(playerCount !== 11 && playerCount > 0) console.warn(`Warning: Starting lineup has ${playerCount} players instead of 11.`);

        const averageRating = playerCount > 0 ? Math.round(totalRating / playerCount) : 60;
        gameState.team.strength = averageRating;
        return averageRating;
    }

    function generateAllPlayers() {
        allPlayers = [];

        // Add real players first, ensuring they have teamLogo
        const premierLeagueData = LEAGUES['England']['Premier League'];
        for (const teamName in REAL_PLAYERS) {
            const teamData = premierLeagueData.teams.find(t => t.name === teamName);
            if(teamData) {
                allPlayers.push(...REAL_PLAYERS[teamName].map(p => ({ ...p, teamName, teamLogo: teamData.logo })));
            }
        }

        const positions = ['K', 'V', 'V', 'V', 'V', 'KP', 'KP', 'KP', 'CS', 'CS', 'CS'];
        const natCodes = Object.keys(NATIONALITIES);

        for (const country in LEAGUES) {
            for (const leagueName in LEAGUES[country]) {
                LEAGUES[country][leagueName].teams.forEach(team => {
                    // Only generate for teams not in REAL_PLAYERS
                    if (!REAL_PLAYERS[team.name]) {
                        for (let i = 0; i < 22; i++) {
                            const baseStrength = team.strength;
                            const playerStrength = Math.max(40, Math.min(99, Math.round(baseStrength - 15 + Math.random() * 25)));
                            const age = getRandomInt(17, 36);
                            const value = Math.round(Math.pow(playerStrength / 10, 3) * Math.max(1, (40 - age)) * 1000);
                            const natCode = getRandomElement(natCodes);

                            allPlayers.push({
                                id: `player_${Date.now()}_${Math.random()}`,
                                name: generatePlayerName(natCode),
                                position: getRandomElement(positions),
                                age: age,
                                rating: playerStrength,
                                value: value,
                                nationality: natCode,
                                teamName: team.name,
                                teamLogo: team.logo
                            });
                        }
                    }
                });
            }
        }
    }
    
    function populateTransferMarket() {
        const container = document.getElementById('transferMarketResults');
        const nameFilter = document.getElementById('playerNameSearch').value.toLowerCase();
        const posFilter = document.getElementById('positionFilter').value;
        
        container.innerHTML = '';
        
        const filteredPlayers = allPlayers.filter(p => {
            if (!p || !p.name) return false;
            const nameMatch = p.name.toLowerCase().includes(nameFilter);
            const posMatch = posFilter ? p.position === posFilter : true;
            const isNotOnUserTeam = !gameState.team.players.some(player => player.id === p.id);
            return nameMatch && posMatch && isNotOnUserTeam;
        });

        if (filteredPlayers.length === 0) {
            container.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nincs a keresésnek megfelelő játékos.</p>`;
            return;
        }

        filteredPlayers.sort((a,b) => b.rating - a.rating).slice(0, 100).forEach(player => {
            const natInfo = NATIONALITIES[player.nationality];
            const flagSrc = natInfo ? natInfo.flag : '';
            const playerCard = document.createElement('div');
            playerCard.className = 'transfer-player-card';
            
            playerCard.innerHTML = `
                <div class="player-card-header">
                    <img src="${flagSrc}" class="player-nat-flag" alt="${player.nationality}">
                    <div class="player-card-name">
                        <strong>${player.name}</strong> (${player.position})
                        <div class="player-card-team">
                            <img src="${player.teamLogo}" alt="${player.teamName}">
                            <span>${player.teamName}</span>
                        </div>
                    </div>
                </div>
                <div class="player-card-body">
                    <span class="stat-rating"><i class="fas fa-star"></i> ${player.rating}</span>
                    <span>Kor: ${player.age}</span>
                    <span class="stat-value">${formatValue(player.value)}</span>
                </div>
                <div class="player-card-footer">
                    <button class="button offer-btn">Ajánlat</button>
                </div>
            `;
            
            playerCard.querySelector('.offer-btn').addEventListener('click', () => {
                showOfferModal(player);
            });
            
            container.appendChild(playerCard);
        });
    }

    function showOfferModal(player) {
        const overlay = document.getElementById('offerModalOverlay');
        const card = document.getElementById('offerModalCard');
        
        card.innerHTML = `
            <h3>Ajánlat a következő játékosért:</h3>
            <div class="offer-player-info">
                <img src="${player.teamLogo}" alt="${player.teamName}">
                <div>
                    <strong>${player.name}</strong>
                    <p>Érték: ${formatValue(player.value)}</p>
                </div>
            </div>
            <div class="offer-input-group">
                <label for="offerAmount">Ajánlatod (€)</label>
                <input type="number" id="offerAmount" value="${player.value}" step="100000">
            </div>
            <p id="offerError" class="error-message hidden">Nincs elég pénzed!</p>
            <div class="navigation-buttons">
                <button class="button prev-btn" id="cancelOfferBtn">Mégse</button>
                <button class="button next-btn" id="submitOfferBtn">Ajánlat elküldése</button>
            </div>
        `;
        
        overlay.classList.remove('hidden');

        document.getElementById('submitOfferBtn').addEventListener('click', () => {
            const amount = parseInt(document.getElementById('offerAmount').value, 10);
            if (gameState.money < amount) {
                document.getElementById('offerError').classList.remove('hidden');
                return;
            }
            
            if (amount >= player.value) {
                gameState.money -= amount;
                updateHeaderUI();
                initiatePlayerSwap(player);
            } else {
                alert(`Az ajánlatodat elutasították. Túl alacsony.`);
            }
            overlay.classList.add('hidden');
        });

        document.getElementById('cancelOfferBtn').addEventListener('click', () => {
            overlay.classList.add('hidden');
        });
    }

    function main() {
        allSaves = loadAllSaves();
        displaySaveSlots();
        
        let progress = 0;
        const loadingBar = document.getElementById('loadingBar');
        const loadingScreen = document.getElementById('loadingScreen');
        
        setTimeout(() => {
            generateAllPlayers();
        }, 100);

        const loadingInterval = setInterval(() => {
            progress += 5;
            loadingBar.style.width = `${progress}%`;
            if (progress >= 100) {
                clearInterval(loadingInterval);
                loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    showMainMenu();
                }, 500);
            }
        }, 50);
    }
    
    function updateUI() {
        if (!gameState || Object.keys(gameState).length === 0) return;
        updateHeaderUI();
        updateDashboardUI();
        updateLeagueTable();
        updateProfileUI();
        updateTransferUI();
        updateSquadScreen();
        if (!document.getElementById('globalTransferScreen').classList.contains('hidden')) {
            populateTransferMarket();
        }
    }

    function showScreen(targetScreenId) {
        allScreens.forEach(screen => screen.classList.add('hidden'));
        const targetScreen = document.getElementById(targetScreenId);
        if (targetScreen) {
            targetScreen.classList.remove('hidden');
        }
        updateNavButtons(targetScreenId);

        if (targetScreenId === 'globalTransferScreen') {
            populateTransferMarket();
        }
         if (targetScreenId === 'squadScreen') {
            updateSquadScreen();
        }
    }
    
    function getTeamData(teamName) {
        for (const country in LEAGUES) {
            for (const leagueName in LEAGUES[country]) {
                const team = LEAGUES[country][leagueName].teams.find(t => t.name === teamName);
                if (team) return team;
            }
        }
        return null;
    }

    function loadAllSaves() {
        const savedData = localStorage.getItem(SAVE_KEY);
        return savedData ? JSON.parse(savedData) : [];
    }

    function saveAllSaves() {
        try {
            const gameIndex = allSaves.findIndex(save => save.id === currentSaveId);
            if (gameIndex !== -1) {
                allSaves[gameIndex] = gameState;
            }
            localStorage.setItem(SAVE_KEY, JSON.stringify(allSaves));
        } catch (e) {
            console.error("Hiba a játék mentésekor: ", e);
        }
    }
    
    function deleteSave(saveId) {
        allSaves = allSaves.filter(save => save.id !== saveId);
        saveAllSaves();
        displaySaveSlots();
    }

    function loadSelectedGame(saveId) {
        const selectedSave = allSaves.find(save => save.id === saveId);
        if (selectedSave) {
            currentSaveId = saveId;
            gameState = selectedSave;

            if (!gameState.team.players || gameState.team.players.length === 0 || !gameState.team.lineup) {
                 generateRosterForTeam(gameState.team.name);
                 saveAllSaves();
            }
            if(!gameState.team.formation) {
                gameState.team.formation = '4-3-3';
                saveAllSaves();
            }

            const leagueData = getLeagueData(gameState.leagueName);
            if (!leagueData) {
                console.error("A mentett játékhoz tartozó bajnokság nem található.");
                mainMenu.classList.remove('hidden');
                return;
            }
            const currentLeagueTeams = leagueData.teams;

            if (!gameState.schedule || gameState.schedule.length === 0 || gameState.currentMatchday >= gameState.schedule.length) {
                gameState.schedule = generateSchedule(currentLeagueTeams.map(t => t.name));
                gameState.currentMatchday = 0;
                gameState.league = currentLeagueTeams.map(t => ({ name: t.name, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 }));
                
                saveAllSaves();
            }
            showMainHub();
        }
    }
    function showMainMenu() {
        mainMenu.classList.remove('hidden');
        characterCreator.classList.add('hidden');
        document.getElementById('mainHub').classList.add('hidden');
        displaySaveSlots();
    }
    
    function displaySaveSlots() {
        const container = document.getElementById('saveSlotsContainer');
        container.innerHTML = allSaves.length === 0 ? '<p style="text-align: center; color: var(--text-muted);">Nincsenek mentett játékok.</p>' : '';

        allSaves.forEach(save => {
            const slot = document.createElement('div');
            slot.className = 'save-slot';
            slot.dataset.id = save.id;
            
            const teamData = getTeamData(save.team.name);
            const teamLogo = teamData ? teamData.logo : 'https://placehold.co/40x40/cccccc/000000?text=?';

            slot.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem; text-align: left;">
                    <img src="${teamLogo}" alt="${save.team.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: contain;">
                    <div class="save-slot-info">
                        <h4>${save.playerName}</h4>
                        <p>${save.team.name} - ${save.leagueName}</p>
                    </div>
                </div>
                <button class="delete-save-btn" data-id="${save.id}">&times;</button>
            `;
            
            container.appendChild(slot);

            slot.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-save-btn')) return;
                const saveId = parseInt(e.currentTarget.dataset.id, 10);
                loadSelectedGame(saveId);
            });

            slot.querySelector('.delete-save-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const saveId = parseInt(e.currentTarget.dataset.id, 10);
                if (confirm(`Biztosan törölni szeretnéd a "${save.playerName}" nevű mentést?`)) {
                    deleteSave(saveId);
                }
            });
        });
    }

    function initializeCharacterCreator() {
        mainMenu.classList.add('hidden');
        characterCreator.classList.remove('hidden');
        
        const formCarousel = document.getElementById('formCarousel');
        const totalSteps = formCarousel.children.length;
        let currentStep = 0;
        const playerNameInput = document.getElementById('playerName');
        const leagueSelectGrid = document.getElementById('leagueSelectGrid');

        function updateCarousel() { formCarousel.style.transform = `translateX(-${currentStep * 100}%)`; }
        
        document.querySelectorAll('#characterCreator .next-btn').forEach(btn => btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentStep === 0 && playerNameInput.value.trim() === "") return;
            if (currentStep === 1 && selectedNationality === null) return;
            if (currentStep === 2 && selectedLeagueName === null) return;
            if (currentStep < totalSteps - 1) { 
                currentStep++;
                if (currentStep === 3) {
                    generateContractOffers();
                }
                updateCarousel();
            }
        }));
        
        document.querySelectorAll('#characterCreator .prev-btn').forEach(btn => btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentStep > 0) { currentStep--; updateCarousel(); }
        }));

        const nationalityOptions = document.getElementById('nationalityOptions');
        nationalityOptions.innerHTML = '';
        for (const code in NATIONALITIES) {
            const nation = NATIONALITIES[code];
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';
            optionDiv.dataset.value = code;
            optionDiv.innerHTML = `<img src="${nation.flag}" alt="${nation.name} zászló"><span>${nation.name}</span>`;
            nationalityOptions.appendChild(optionDiv);
        }

        const nationalitySelectBtn = document.getElementById('nationalitySelect');
        nationalitySelectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            nationalityOptions.classList.toggle('hidden');
        });
        document.addEventListener('click', () => { nationalityOptions.classList.add('hidden'); });
        nationalityOptions.addEventListener('click', (e) => {
            const option = e.target.closest('.option');
            if (option) {
                selectedNationality = option.dataset.value;
                const selectedOptionDisplay = document.querySelector('#nationalitySelect .selected-option');
                selectedOptionDisplay.innerHTML = `<img src="${NATIONALITIES[selectedNationality].flag}" alt="${NATIONALITIES[selectedNationality].name} zászló"><span>${NATIONALITIES[selectedNationality].name}</span>`;
                nationalityOptions.classList.add('hidden');
            }
        });

        leagueSelectGrid.innerHTML = '';
        for (const country in LEAGUES) {
            for (const leagueName in LEAGUES[country]) {
                if (LEAGUES[country][leagueName].tier === 1) {
                    const button = document.createElement('button');
                    button.className = 'league-select-btn';
                    button.textContent = leagueName;
                    button.dataset.league = leagueName;
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.league-select-btn').forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        selectedLeagueName = leagueName;
                    });
                    leagueSelectGrid.appendChild(button);
                }
            }
        }
    }

    function generateContractOffers() {
        const offersContainer = document.getElementById('contractOffersContainer');
        offersContainer.innerHTML = '';
        
        const leagueData = getLeagueData(selectedLeagueName);
        if (!leagueData) return;
        const leagueTeams = leagueData.teams;
        const smallTeams = leagueTeams.filter(t => t.strength <= 75);
        
        const offers = [];
        const chosenTeams = new Set();
        while (offers.length < 2 && chosenTeams.size < leagueTeams.length) {
            const teamPool = smallTeams.length >= 2 ? smallTeams : leagueTeams;
            const team = getRandomElement(teamPool);
            if (!chosenTeams.has(team.name)) {
                chosenTeams.add(team.name);
                offers.push(team);
            }
        }

        showOffers(offers);
    }
    
    function showOffers(offers) {
        const offersContainer = document.getElementById('contractOffersContainer');
        offers.forEach(team => {
            const teamOfferCard = document.createElement('div');
            teamOfferCard.className = 'contract-offer-card';
            teamOfferCard.innerHTML = `
                <img src="${team.logo}" alt="${team.name} logó">
                <h3>${team.name}</h3>
                <p><strong>Fizetés:</strong> €15.000 /hét</p>
                <button class="button submit-btn accept-offer-btn" data-team='${JSON.stringify(team)}'>Szerződés aláírása</button>
            `;
            offersContainer.appendChild(teamOfferCard);
        });

        document.querySelectorAll('.accept-offer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const team = JSON.parse(e.target.dataset.team);
                startNewGame(team);
            });
        });
    }

    function generateRosterForTeam(teamName) {
        let teamPlayers;
        if (REAL_PLAYERS[teamName]) {
            teamPlayers = REAL_PLAYERS[teamName].map(p => ({ ...p, teamName: teamName, teamLogo: getTeamData(teamName).logo }));
        } else {
            teamPlayers = allPlayers.filter(p => p.teamName === teamName);
        }
        
        const positions = { 'K': [], 'V': [], 'KP': [], 'CS': [] };
        teamPlayers.forEach(p => {
            if (positions[p.position]) {
                positions[p.position].push(p);
            }
        });
        
        const roster = [
            ...positions['K'].slice(0, 2), ...positions['V'].slice(0, 6),
            ...positions['KP'].slice(0, 6), ...positions['CS'].slice(0, 4)
        ].slice(0, 18);
        gameState.team.players = roster;

        const userPlayer = {
            id: 'user_player', name: gameState.playerName, position: 'CS',
            age: gameState.age, rating: gameState.rating, teamName: gameState.team.name, isUser: true
        };
        
        let playerToReplace = roster.find(p => p.position === 'CS') || roster[roster.length - 1];
        const playerToReplaceIndex = gameState.team.players.findIndex(p => p.id === playerToReplace.id);

        if (playerToReplaceIndex !== -1) {
            gameState.team.players.splice(playerToReplaceIndex, 1, userPlayer);
        } else {
             gameState.team.players.push(userPlayer);
        }
        
        setFormation('4-3-3', true);
    }

    function startNewGame(chosenTeam) {
        const leagueData = getLeagueData(selectedLeagueName);
        const leagueTeams = leagueData.teams;
        
        gameState = {
            id: Date.now(),
            playerName: document.getElementById('playerName').value || "Játékos",
            age: 17, nationality: selectedNationality, leagueName: selectedLeagueName,
            rating: 60, money: 250000, salary: 15000, 
            goals: 0, assists: 0, matchesPlayed: 0, trophies: [],
            clubHistory: [{ name: chosenTeam.name, year: new Date().getFullYear() + '-' }],
            league: leagueTeams.map(t => ({ name: t.name, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 })),
            currentMatchday: 0, jerseyNumber: Math.floor(Math.random() * 98) + 1,
            schedule: generateSchedule(leagueTeams.map(t => t.name)),
            transferOffers: [], coins: 10, team: { ...chosenTeam, formation: '4-3-3' }
        };

        generateRosterForTeam(chosenTeam.name);
        
        currentSaveId = gameState.id;
        allSaves.push(gameState);
        saveAllSaves();

        characterCreator.classList.add('hidden');
        showMainHub();
    }
    
    // --- MECCS LOGIKA (A tömörségért rövidítve, a lényeg a UI és csapatkezelésben) ---
    function playNextMatch() { alert("A meccs funkció fejlesztés alatt áll!"); }
    function startMatchSimulator() { /* ... */ }
    function runSimulation(homeTeam, awayTeam) { /* ... */ }
    function endMatchGame() { /* ... */ }
    
    // --- CSAPATKEZELÉS ---
    let draggedPlayerId = null;
    let draggedFromSlotId = null;

    function handleDragStart(e, playerId, fromSlotId) {
        draggedPlayerId = playerId;
        draggedFromSlotId = fromSlotId;
        e.dataTransfer.setData('text/plain', playerId);
        setTimeout(() => {
            e.target.classList.add('dragging');
        }, 0);
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        draggedPlayerId = null;
        draggedFromSlotId = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        const slot = e.target.closest('.player-slot');
        if(slot) {
            document.querySelectorAll('.drop-hover').forEach(el => el.classList.remove('drop-hover'));
            slot.classList.add('drop-hover');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        document.querySelectorAll('.drop-hover').forEach(el => el.classList.remove('drop-hover'));
        const targetSlot = e.target.closest('.player-slot');
        if (!targetSlot || !draggedPlayerId || !draggedFromSlotId) return;

        const targetSlotId = targetSlot.id;

        const targetPlayerId = gameState.team.lineup[targetSlotId] || null;
        
        gameState.team.lineup[draggedFromSlotId] = targetPlayerId;
        gameState.team.lineup[targetSlotId] = draggedPlayerId;

        saveAllSaves();
        updateSquadScreen();
    }

    function createFormationSlots(formation, container, isBench = false) {
        container.innerHTML = '';
        for (let i = 1; i <= formation; i++) {
            const slot = document.createElement('div');
            slot.className = 'player-slot';
            slot.id = isBench ? `bench-${i}` : `${container.id.replace('-players', '').replace('-forwards', '').replace('-midfielders', '').replace('-defenders', '').replace('-goalkeeper', '')}-${i}`;
            container.appendChild(slot);
        }
    }
    
    function setFormation(formationStr, isInitial = false) {
         if (!isInitial) {
             // Move all players to bench before changing formation
             let playersOnPitch = [];
             for (const slotId in gameState.team.lineup) {
                 if (!slotId.startsWith('bench') && gameState.team.lineup[slotId]) {
                     playersOnPitch.push(gameState.team.lineup[slotId]);
                 }
             }
            
             let benchPlayers = [];
             for (const slotId in gameState.team.lineup) {
                  if (slotId.startsWith('bench') && gameState.team.lineup[slotId]) {
                      benchPlayers.push(gameState.team.lineup[slotId]);
                  }
             }
             const allPlayersOnBench = [...playersOnPitch, ...benchPlayers];
            
             // Clear lineup
             gameState.team.lineup = {};

             allPlayersOnBench.forEach((playerId, index) => {
                 gameState.team.lineup[`bench-${index+1}`] = playerId;
             });
         }
    
        gameState.team.formation = formationStr;
        
        // Auto-populate the new formation
        const formationConfig = FORMATIONS[formationStr];
        const newLinup = {};

        // Keep GK
        const gk = gameState.team.players.find(p => p.position === 'K' && !Object.values(newLinup).includes(p.id));
        if (gk) newLinup['formation-goalkeeper-1'] = gk.id;
        
        // Populate defenders
        for(let i = 1; i <= formationConfig.defenders; i++) {
            const player = gameState.team.players.find(p => p.position === 'V' && !Object.values(newLinup).includes(p.id));
            if (player) newLinup[`formation-defenders-${i}`] = player.id;
        }
        // Populate midfielders
        for(let i = 1; i <= formationConfig.midfielders; i++) {
            const player = gameState.team.players.find(p => p.position === 'KP' && !Object.values(newLinup).includes(p.id));
            if (player) newLinup[`formation-midfielders-${i}`] = player.id;
        }
        // Populate forwards
        for(let i = 1; i <= formationConfig.forwards; i++) {
            const player = gameState.team.players.find(p => p.position === 'CS' && !Object.values(newLinup).includes(p.id));
            if (player) newLinup[`formation-forwards-${i}`] = player.id;
        }

        // Fill remaining players on bench
        const playersOnPitch = Object.values(newLinup);
        const remainingPlayers = gameState.team.players.filter(p => !playersOnPitch.includes(p.id));
        remainingPlayers.forEach((player, i) => {
            newLinup[`bench-${i+1}`] = player.id;
        });

        gameState.team.lineup = newLinup;

        updateFormationSelector();
        updateSquadScreen();
        saveAllSaves();
    }

    function updateFormationSelector() {
        const container = document.getElementById('formationSelector');
        container.innerHTML = '';
        Object.keys(FORMATIONS).forEach(key => {
            const button = document.createElement('button');
            button.textContent = key;
            button.className = `button formation-btn ${gameState.team.formation === key ? 'active' : ''}`;
            button.addEventListener('click', () => setFormation(key));
            container.appendChild(button);
        });
    }

    function updateSquadScreen() {
        if (!gameState || !gameState.team || !gameState.team.players) return;
        
        document.getElementById('squadTeamName').textContent = `${gameState.team.name}`;
        updateFormationSelector();

        const formationConfig = FORMATIONS[gameState.team.formation];
        createFormationSlots(formationConfig.forwards, document.getElementById('formation-forwards'));
        createFormationSlots(formationConfig.midfielders, document.getElementById('formation-midfielders'));
        createFormationSlots(formationConfig.defenders, document.getElementById('formation-defenders'));
        createFormationSlots(1, document.getElementById('formation-goalkeeper'));
        createFormationSlots(7, document.getElementById('bench-players'), true);
        
        const allSlots = document.querySelectorAll('.player-slot');
        allSlots.forEach(slot => {
            slot.innerHTML = ''; // Clear previous cards
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('dragleave', () => slot.classList.remove('drop-hover'));
            slot.addEventListener('drop', handleDrop);
        });

        for (const slotId in gameState.team.lineup) {
            const playerId = gameState.team.lineup[slotId];
            const slotElement = document.getElementById(slotId);

            if (playerId && slotElement) {
                const player = gameState.team.players.find(p => p.id === playerId);
                if (player) {
                    const card = document.createElement('div');
                    card.className = 'squad-player-card';
                    card.draggable = true;
                    if (player.isUser) card.classList.add('user-player-card');

                    card.innerHTML = `
                        <div class="rating">${player.rating}</div>
                        <div class="position">${player.position}</div>
                        <div class="name">${player.name.split(' ').pop()}</div>
                    `;
                    
                    card.addEventListener('dragstart', (e) => handleDragStart(e, player.id, slotId));
                    card.addEventListener('dragend', handleDragEnd);
                    
                    slotElement.appendChild(card);
                }
            }
        }
        document.getElementById('squadAvgRating').textContent = calculateTeamStrength();
    }

    function initiatePlayerSwap(newPlayer) {
        const overlay = document.getElementById('playerSwapModalOverlay');
        const card = document.getElementById('playerSwapModalCard');
        
        const rosterHTML = gameState.team.players.map((p) => {
            if (!p) return '';
            return `
                <div class="swap-player-row ${p.isUser ? 'is-user' : ''}">
                    <span>(${p.position}) ${p.name}</span>
                    <span class="stat-rating"><i class="fas fa-star"></i> ${p.rating}</span>
                    <button class="button swap-btn" data-player-id="${p.id}" ${p.isUser ? 'disabled' : ''}>Csere</button>
                </div>`;
        }).join('');

        card.innerHTML = `
            <h3>Játékoscsere</h3>
            <p>Válaszd ki, kire cseréled az új igazolásodat:</p>
            <div class="offer-player-info"><strong>Új játékos: ${newPlayer.name} (${newPlayer.rating})</strong></div>
            <div class="swap-roster-list">${rosterHTML}</div>
            <button class="button prev-btn" id="cancelSwapBtn" style="margin-top: 1rem;">Mégse</button>`;

        overlay.classList.remove('hidden');

        const swapHandler = (e) => {
            if (!e.target.classList.contains('swap-btn')) return;
            const playerIdToReplace = e.target.dataset.playerId;
            const playerIndexToReplace = gameState.team.players.findIndex(p => p.id === playerIdToReplace);

            if (playerIndexToReplace !== -1) {
                let slotToReplace = null;
                for (const slotId in gameState.team.lineup) {
                    if (gameState.team.lineup[slotId] === playerIdToReplace) {
                        slotToReplace = slotId;
                        break;
                    }
                }
                
                // Simple swap in the players array
                gameState.team.players.splice(playerIndexToReplace, 1, newPlayer);

                // Update the lineup if the replaced player was on the pitch/bench
                if (slotToReplace) {
                    gameState.team.lineup[slotToReplace] = newPlayer.id;
                }
                
                saveAllSaves();
                updateUI();
                overlay.classList.add('hidden');
                // Clean up listener to prevent duplicates
                card.removeEventListener('click', swapHandler);
            }
        };

        const cancelHandler = () => {
             overlay.classList.add('hidden');
             card.removeEventListener('click', swapHandler);
             card.querySelector('#cancelSwapBtn').removeEventListener('click', cancelHandler);
        };

        card.addEventListener('click', swapHandler);
        card.querySelector('#cancelSwapBtn').addEventListener('click', cancelHandler);
    }
    
    // --- UI FRISSÍTÉSEK ---

    function updateNavButtons(activeScreenId) {
        allNavButtons.forEach(button => {
            if (button.dataset.screen === activeScreenId) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }
    
    function showMainHub() {
        characterCreator.classList.add('hidden');
        mainMenu.classList.add('hidden');
        matchResultOverlay.classList.add('hidden');
        document.getElementById('mainHub').classList.remove('hidden');
        showScreen('dashboardScreen');
        updateUI();
    }
    
    function updateHeaderUI() {
        document.getElementById('headerPlayerName').textContent = gameState.playerName;
        document.getElementById('headerPlayerMoney').textContent = `€${gameState.money.toLocaleString()}`;
        document.getElementById('headerPlayerCoins').textContent = gameState.coins;
    }
    
    function updateDashboardUI() {
        document.getElementById('hubPlayerName').textContent = gameState.playerName;
        document.getElementById('hubPlayerTeamName').textContent = gameState.team.name;
        document.getElementById('hubPlayerTeamLogo').src = gameState.team.logo;
        document.getElementById('hubPlayerRating').textContent = gameState.rating;
        document.getElementById('hubPlayerAge').textContent = gameState.age;

        const nextMatch = getNextMatch();
        if (nextMatch) {
            document.getElementById('hubNextOpponent').textContent = nextMatch.opponent;
        } else {
             document.getElementById('hubNextOpponent').textContent = "Szezon vége";
             document.getElementById('playMatchBtn').disabled = true;
        }

        const teamStats = gameState.league.find(t => t.name === gameState.team.name);
        const position = gameState.league.sort((a,b) => b.points - a.points || b.gd - a.gd).findIndex(t => t.name === gameState.team.name) + 1;
        document.getElementById('hubLeaguePosition').textContent = `${position}.`;
        document.getElementById('hubMatchday').textContent = `${gameState.currentMatchday} / ${(gameState.league.length-1) * 2}`;
    }

    function updateProfileUI() {
        document.getElementById('profilePlayerName').textContent = `${gameState.playerName} profilja`;
        document.getElementById('profileGoals').textContent = gameState.goals;
        document.getElementById('profileAssists').textContent = gameState.assists;
        document.getElementById('profileMatches').textContent = gameState.matchesPlayed;
        document.getElementById('profileTrophies').textContent = gameState.trophies.length;
    }
    
    function updateTransferUI() {
        const container = document.getElementById('transferOffers');
        if (gameState.transferOffers.length > 0) {
            container.innerHTML = '';
            // TODO: Display offers
        } else {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Jelenleg nincsenek ajánlatok.</p>';
        }
    }

    function updateLeagueTable() {
        const tableBody = document.getElementById('leagueTableBody');
        const currentLeagueName = gameState.leagueName;
        document.getElementById('leagueTitle').textContent = currentLeagueName;

        tableBody.innerHTML = '';

        const sortedLeague = [...gameState.league].sort((a,b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.gd !== a.gd) return b.gd - a.gd;
            if (b.gf !== a.gf) return b.gf - a.gf;
            return a.name.localeCompare(b.name);
        });

        sortedLeague.forEach((team, index) => {
            const row = document.createElement('tr');
            if (team.name === gameState.team.name) {
                row.classList.add('player-team');
            }
            const teamData = getTeamData(team.name);

            row.innerHTML = `
                <td>${index + 1}</td>
                <td class="team-cell">
                    <img src="${teamData.logo}" alt="${team.name}">
                    <span>${team.name}</span>
                </td>
                <td class="hide-on-mobile">${team.played}</td>
                <td class="hide-on-mobile">${team.wins}</td>
                <td class="hide-on-mobile">${team.draws}</td>
                <td class="hide-on-mobile">${team.losses}</td>
                <td>${team.gd}</td>
                <td><strong>${team.points}</strong></td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    function getLeagueData(leagueName) {
        for (const country in LEAGUES) {
            if (LEAGUES[country][leagueName]) {
                return LEAGUES[country][leagueName];
            }
        }
        return null;
    }
    
    function generateSchedule(teams) {
        const schedule = [];
        const numTeams = teams.length;
        if (numTeams % 2 !== 0) {
            console.error("A csapatok száma páratlan, nem lehet sorsolást generálni.");
            return [];
        }

        const rounds = numTeams - 1;
        const matchesPerRound = numTeams / 2;

        for (let round = 0; round < rounds; round++) {
            const roundMatches = [];
            for (let match = 0; match < matchesPerRound; match++) {
                const home = (round + match) % (numTeams - 1);
                let away = (numTeams - 1 - match + round) % (numTeams - 1);
                if (match === 0) {
                    away = numTeams - 1;
                }
                roundMatches.push({ home: teams[home], away: teams[away] });
            }
            schedule.push(roundMatches);
        }
        
        const secondHalf = [];
        schedule.forEach(round => {
            const newRound = round.map(match => ({home: match.away, away: match.home}));
            secondHalf.push(newRound);
        });

        return [...schedule, ...secondHalf];
    }
    
    function getNextMatch() {
        if (gameState.currentMatchday >= gameState.schedule.length) {
            return null; // Season over
        }
        const currentRound = gameState.schedule[gameState.currentMatchday];
        const playerTeamName = gameState.team.name;
        const match = currentRound.find(m => m.home === playerTeamName || m.away === playerTeamName);
        if (!match) return null;
        
        return {
            home: match.home,
            away: match.away,
            opponent: match.home === playerTeamName ? match.away : match.home
        };
    }
    
    function togglePause() {
        isPaused = !isPaused;
        const icon = document.querySelector('#sim-pause-btn i');
        icon.className = isPaused ? 'fas fa-play' : 'fas fa-pause';
    }
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    // Event Listenerek
    document.querySelectorAll('.stat-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.stat-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            document.querySelectorAll('.stats-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tab.dataset.content).classList.remove('hidden');
        });
    });

    allNavButtons.forEach(button => button.addEventListener('click', () => showScreen(button.dataset.screen)));
    document.getElementById('profileBtn')?.addEventListener('click', () => showScreen('profileScreen'));
    document.getElementById('dashboardProfileCard')?.addEventListener('click', () => showScreen('squadScreen'));
    document.getElementById('playMatchBtn')?.addEventListener('click', playNextMatch);
    document.getElementById('matchResultContinueBtn')?.addEventListener('click', showMainHub);
    document.getElementById('sim-pause-btn')?.addEventListener('click', togglePause);
    document.getElementById('newGameBtn')?.addEventListener('click', initializeCharacterCreator);
    document.getElementById('playerNameSearch').addEventListener('input', populateTransferMarket);
    document.getElementById('positionFilter').addEventListener('change', populateTransferMarket);
    
    window.addEventListener('resize', resizeCanvas);
    main();
});
    </script>
</body>
</html>
