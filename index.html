<!DOCTYPE html>

<html lang="hu">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>Football Crazy - A Karrier</title>

    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="leagues.js" defer></script>

    <script src="nationalities.js" defer></script>

    <script src="names.js" defer></script>

</head>

<body>



    <div class="loading-screen" id="loadingScreen">

        <svg class="football-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ffffff" d="M256 512c141.4 0 256-114.6 256-256S397.4 0 256 0S0 114.6 0 256S114.6 512 256 512zM152 352h32v32c0 17.7-14.3 32-32 32s-32-14.3-32-32V320c0-17.7 14.3-32 32-32h64c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V352H152zM280 288c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32H280zm64-224c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32h64c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32H344zM120 96c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32s32-14.3 32-32V128c0-17.7-14.3-32-32-32zm88 64c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32h64c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32H208z"/></svg>

        <h1 class="loading-title">Football Crazy</h1>

        <div class="loading-bar-container">

            <div class="loading-bar" id="loadingBar"></div>

        </div>

    </div>



    <div class="main-menu-container hidden" id="mainMenu">

        <h1 class="menu-title">Football Crazy</h1>

        <div class="menu-buttons">

            <button class="button next-btn" id="newGameBtn">Új Karrier</button>

        </div>

        <div id="saveSlotsContainer" class="save-slots-container">

            <!-- Mentési helyek dinamikusan generálva -->

        </div>

    </div>



    <div class="character-creator-container hidden" id="characterCreator">

        <div class="form-carousel" id="formCarousel">

            <div class="form-step">

                <h2>Add meg a neved</h2>

                <p class="form-description">Ez a név fog megjelenni a mezeken és a sajtóban.</p>

                <input type="text" id="playerName" placeholder="pl. Minta János" required>

                <div class="navigation-buttons" style="justify-content: flex-end;"><button class="button next-btn">Tovább &rarr;</button></div>

            </div>

            <div class="form-step">

                <h2>Válaszd ki a nemzetiséged</h2>

                <p class="form-description">Melyik országot képviseled a nemzetközi porondon?</p>

                <div class="custom-select-wrapper">

                    <div class="select-button" id="nationalitySelect">

                        <div class="selected-option" data-value="hu"><img src="https://flagcdn.com/w40/hu.png" alt="Magyar zászló"><span>Magyar</span></div><span>&#9660;</span>

                    </div>

                    <div class="select-options hidden" id="nationalityOptions">

                        <!-- Options are generated from nationalities.js -->

                    </div>

                </div>

                <div class="navigation-buttons"><button class="button prev-btn">&larr; Vissza</button><button class="button next-btn">Tovább &rarr;</button></div>

            </div>

            <div class="form-step">

                <h2>Válaszd ki a bajnokságot</h2>

                <p class="form-description">Válassz egy bajnokságot, ahol elindítod a karriered.</p>

                <div class="league-select-grid" id="leagueSelectGrid">

                    <!-- Dinamikusan generálva JS-ből -->

                </div>

                <div class="navigation-buttons"><button class="button prev-btn">&larr; Vissza</button><button class="button next-btn">Tovább &rarr;</button></div>

            </div>

            <div class="form-step">

                <h2>Aláírnád a szerződést?</h2>

                <p style="text-align: center; color: var(--text-muted);">Válassz a két felajánlott csapat közül, és indítsd el a karriered!</p>

                <div class="contract-offers-container" id="contractOffersContainer">

                    <!-- Ajánlatok generálása JS-ből -->

                </div>

                <div class="navigation-buttons" style="justify-content: flex-start;"><button class="button prev-btn">&larr; Vissza</button></div>

            </div>

        </div>

    </div>

    

    <div class="overlay hidden" id="matchResultOverlay">

        <div class="card">

            <div class="match-result-header">

                <div class="match-result-team">

                    <img id="resultHomeLogo" src="" alt="Hazai csapat logó">

                    <h3 id="resultHomeName">Hazai</h3>

                </div>

                <div class="match-result-score" id="resultScore">0 - 0</div>

                <div class="match-result-team">

                    <img id="resultAwayLogo" src="" alt="Vendég csapat logó">

                    <h3 id="resultAwayName">Vendég</h3>

                </div>

            </div>

            <div class="match-summary">

                <h4>Teljesítményed</h4>

                <p id="resultPlayerPerformance">Gólok: 0, Gólpasszok: 0</p>

                <h4>Jutalom</h4>

                <p id="resultEarnings">Fizetés: €0, Bónusz: €0</p>

            </div>

            <button class="button continue-btn" id="matchResultContinueBtn">Tovább</button>

        </div>

    </div>



    <div class="overlay hidden" id="offerModalOverlay">

        <div class="card" id="offerModalCard">

            <!-- Tartalom dinamikusan generálva JS-ből -->

        </div>

    </div>

    

    <div class="overlay hidden" id="playerSwapModalOverlay">

        <div class="card" id="playerSwapModalCard">

             <!-- Tartalom dinamikusan generálva JS-ből -->

        </div>

    </div>



    <div id="matchSimulatorOverlay" class="overlay hidden">

        <div class="simulator-container">

            <div class="sim-header">

                <div class="sim-team sim-team-home">

                    <span id="simHomeName">Hazai</span>

                </div>

                <div class="sim-score-time">

                    <span id="simScore">0 - 0</span>

                    <span id="simTime">00:00</span>

                </div>

                <div class="sim-team sim-team-away">

                    <span id="simAwayName">Vendég</span>

                </div>

            </div>

            <div id="commentary-timeline" class="commentary-timeline"></div>

            <div id="pitch-enter-banner" class="pitch-enter-banner hidden">

                <i class="fas fa-running"></i>

                <span id="bannerPlayerName"></span> is on the pitch!

            </div>

            <div id="half-time-banner" class="pitch-enter-banner hidden">

                <i class="fas fa-coffee"></i>

                <span>Félidő</span>

            </div>

        </div>

        <button id="sim-pause-btn" class="sim-pause-btn"><i class="fas fa-pause"></i></button>

    </div>



    <div class="overlay hidden" id="matchGameOverlay">

        <div class="game-scoreboard-wrapper">

            <div id="game-scoreboard" class="game-scoreboard">

                <div class="team-info left">

                    <span id="gameHomeName">HOM</span>

                </div>

                <div class="score-info">

                    <div id="gameScore">0 - 0</div>

                    <div class="score-timeline">

                        <span id="homeProgress"></span>

                        <span id="awayProgress"></span>

                    </div>

                </div>

                <div class="team-info right">

                    <span id="gameAwayName">AWY</span>

                </div>

                <div id="gameTime" style="display:none;">00:00</div>

            </div>

        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="mobile-controls">

            <div id="joystick-zone" class="joystick-zone">

                <div id="joystick-handle" class="joystick-handle"></div>

            </div>

            <div class="action-buttons">

                <button id="pass-btn" class="action-btn pass-btn">

                    <i class="fas fa-exchange-alt"></i>

                    <span>Passz</span>

                </button>

                <button id="shoot-btn" class="action-btn shoot-btn">

                    <i class="fas fa-futbol"></i>

                    <span>Lövés</span>

                </button>

            </div>

        </div>

    </div>



    <div class="main-hub hidden" id="mainHub">

        <nav class="sidebar">

            <button class="nav-btn active" data-screen="dashboardScreen" data-tooltip="Irányítópult"><i class="fas fa-tachometer-alt"></i></button>

            <button class="nav-btn" data-screen="squadScreen" data-tooltip="Csapat"><i class="fas fa-users"></i></button>

            <button class="nav-btn" data-screen="leagueScreen" data-tooltip="Bajnokság"><i class="fas fa-trophy"></i></button>

            <button class="nav-btn" data-screen="playerTransferScreen" data-tooltip="Saját Ajánlatok"><i class="fas fa-arrows-alt-h"></i></button>

            <button class="nav-btn" data-screen="globalTransferScreen" data-tooltip="Igazolások"><i class="fas fa-globe-europe"></i></button>

        </nav>

        <div class="hub-content-wrapper">

            <header class="top-bar">

                <button id="profileBtn" class="profile-btn">

                    <i class="fas fa-user"></i> 

                    <span id="headerPlayerName">Játékos Neve</span>

                </button>

                <div class="currency-display">

                    <div class="currency-item">

                        <i class="fas fa-money-bill-wave" style="color: #2ecc71;"></i>

                        <span id="headerPlayerMoney">0</span>

                    </div>

                    <div class="currency-item">

                        <i class="fas fa-coins" style="color: #f1c40f;"></i>

                        <span id="headerPlayerCoins">0</span>

                    </div>

                </div>

            </header>

            <main class="main-content">

                <div id="dashboardScreen" class="screen">

                    <div class="dashboard-grid">

                        <div class="dashboard-card player-profile-card" id="dashboardProfileCard">

                            <div class="card-header">

                                <img id="hubPlayerTeamLogo" class="team-logo" src="" alt="Csapat Logó">

                                <div class="player-info">

                                    <h4 id="hubPlayerName">Játékos Neve</h4>

                                    <p id="hubPlayerTeamName">Csapat Neve</p>

                                </div>

                            </div>

                            <p><strong>Értékelés:</strong> <span id="hubPlayerRating">85</span></p>

                            <p><strong>Életkor:</strong> <span id="hubPlayerAge">17</span></p>

                        </div>

                        <div class="dashboard-card">

                            <div class="card-header">

                                <i class="fas fa-calendar-alt"></i>

                                <h3>Következő Meccs</h3>

                            </div>

                            <p><strong>Ellenfél:</strong> <span id="hubNextOpponent">Nincs sorsolás</span></p>

                            <button class="button next-btn" style="width: 100%;" id="playMatchBtn">Meccs Indítása</button>

                        </div>

                        <div class="dashboard-card">

                            <div class="card-header">

                                <i class="fas fa-list-ol"></i>

                                <h3>Bajnokság</h3>

                            </div>

                            <p><strong>Helyezés:</strong> <span id="hubLeaguePosition">-.</span></p>

                            <p><strong>Forduló:</strong> <span id="hubMatchday">0 / 14</span></p>

                        </div>

                    </div>

                </div>

                <div id="squadScreen" class="screen hidden">

                    <h2 id="squadTeamName">Csapatom</h2>

                    <div class="pitch">

                        <div class="pitch-lines"></div>

                        <div class="formation" id="formation-forwards"></div>

                        <div class="formation" id="formation-midfielders"></div>

                        <div class="formation" id="formation-defenders"></div>

                        <div class="formation" id="formation-goalkeeper"></div>

                    </div>

                </div>

                <div id="leagueScreen" class="screen hidden">

                    <div class="league-header">

                        <i id="leagueNavPrev" class="fas fa-chevron-left nav-arrow"></i>

                        <h2 id="leagueTitle">Bajnoki Tabella</h2>

                        <i id="leagueNavNext" class="fas fa-chevron-right nav-arrow"></i>

                    </div>

                    <div class="stats-tabs">

                        <button class="stat-tab active" data-content="leagueTableContainer">Tabella</button>

                        <button class="stat-tab" data-content="scorersContainer">Góllövők</button>

                        <button class="stat-tab" data-content="assistsContainer">Asszisztok</button>

                    </div>



                    <div id="leagueTableContainer" class="stats-content">

                        <table class="league-table">

                            <thead>

                                <tr>

                                    <th>#</th><th>Csapat</th>

                                    <th class="hide-on-mobile">M</th><th class="hide-on-mobile">Gy</th><th class="hide-on-mobile">D</th><th class="hide-on-mobile">V</th>

                                    <th>GK</th><th>P</th>

                                </tr>

                            </thead>

                            <tbody id="leagueTableBody"></tbody>

                        </table>

                    </div>

                    <div id="scorersContainer" class="stats-content hidden">

                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">A góllövőlista a következő frissítésben érkezik!</p>

                    </div>

                    <div id="assistsContainer" class="stats-content hidden">

                        <p style="text-align: center; color: var(--text-muted); padding: 20px;">Az asszisztlista a következő frissítésben érkezik!</p>

                    </div>

                </div>

                <div id="profileScreen" class="screen hidden profile-screen">

                    <h2 id="profilePlayerName">Játékos Profilja</h2>

                    <div class="stats-grid">

                        <div class="stat-card"><div class="stat-value" id="profileGoals">0</div><div class="stat-label">Gólok</div></div>

                        <div class="stat-card"><div class="stat-value" id="profileAssists">0</div><div class="stat-label">Gólpasszok</div></div>

                        <div class="stat-card"><div class="stat-value" id="profileMatches">0</div><div class="stat-label">Játszott Meccsek</div></div>

                        <div class="stat-card"><div class="stat-value" id="profileTrophies">0</div><div class="stat-label">Trófeák</div></div>

                    </div>

                    <div class="transfer-card" style="margin-top: 25px;">

                        <h2>Képességfejlesztés</h2>

                        <p style="text-align: center; color: var(--text-muted);">Gyémántokért fejlesztheted a játékosod képességeit. A funkció a következő frissítésben érkezik!</p>

                    </div>

                </div>

                <div id="playerTransferScreen" class="screen hidden">

                    <div class="transfer-card">

                        <h2>Saját átigazolási ajánlatok</h2>

                        <div id="transferOffers">

                            <p style="text-align: center; color: var(--text-muted);">Jelenleg nincsenek ajánlatok.</p>

                        </div>

                    </div>

                </div>

                <div id="globalTransferScreen" class="screen hidden">

                    <h2>Igazolási Piac</h2>

                    <div class="transfer-filters">

                        <input type="text" id="playerNameSearch" placeholder="Játékos keresése...">

                        <select id="positionFilter">

                            <option value="">Minden poszt</option>

                            <option value="CS">Csatár (CS)</option>

                            <option value="KP">Középpályás (KP)</option>

                            <option value="V">Védő (V)</option>

                            <option value="K">Kapus (K)</option>

                        </select>

                    </div>

                    <div class="transfer-market-results" id="transferMarketResults">

                        <!-- Player cards will be generated here -->

                    </div>

                </div>

            </main>

        </div>

        <nav class="bottom-bar">

            <button class="nav-btn active" data-screen="dashboardScreen"><i class="fas fa-tachometer-alt"></i></button>

            <button class="nav-btn" data-screen="squadScreen"><i class="fas fa-users"></i></button>

            <button class="nav-btn" data-screen="leagueScreen"><i class="fas fa-trophy"></i></button>

            <button class="nav-btn" data-screen="playerTransferScreen"><i class="fas fa-arrows-alt-h"></i></button>

            <button class="nav-btn" data-screen="globalTransferScreen"><i class="fas fa-globe-europe"></i></button>

        </nav>

    </div>

    

    <script>

document.addEventListener('DOMContentLoaded', () => {

    let allPlayers = []; 

    // --- SEGÉDFÜGGVÉNYEK ---

    function getRandomInt(min, max) {

        min = Math.ceil(min);

        max = Math.floor(max);

        return Math.floor(Math.random() * (max - min + 1)) + min;

    }



    function getRandomElement(arr) {

        if (!arr || arr.length === 0) return null;

        return arr[Math.floor(Math.random() * arr.length)];

    }



    function generatePlayerName(nationalityCode) {

        const nameData = NAMES[nationalityCode] || NAMES['en'];

        const firstName = getRandomElement(nameData.firstNames);

        const lastName = getRandomElement(nameData.lastNames);

        return `${firstName} ${lastName}`;

    }



    function formatValue(value) {

        if (value >= 1000000) {

            return `€${(value / 1000000).toFixed(1)}M`;

        } else if (value >= 1000) {

            return `€${Math.round(value / 1000)}K`;

        }

        return `€${value}`;

    }



    function generateAllPlayers() {

        allPlayers = [];

        const positions = ['K', 'V', 'V', 'V', 'V', 'KP', 'KP', 'KP', 'CS', 'CS', 'CS'];

        const natCodes = Object.keys(NATIONALITIES);



        for (const country in LEAGUES) {

            for (const leagueName in LEAGUES[country]) {

                LEAGUES[country][leagueName].teams.forEach(team => {

                    for (let i = 0; i < 22; i++) {

                        const baseStrength = team.strength;

                        const playerStrength = Math.max(40, Math.min(99, Math.round(baseStrength - 15 + Math.random() * 25)));

                        const age = getRandomInt(17, 36);

                        const value = Math.round(Math.pow(playerStrength / 10, 3) * Math.max(1, (40 - age)) * 1000);

                        const natCode = getRandomElement(natCodes);



                        allPlayers.push({

                            id: `player_${Date.now()}_${Math.random()}`,

                            name: generatePlayerName(natCode),

                            position: getRandomElement(positions),

                            age: age,

                            rating: playerStrength,

                            value: value,

                            nationality: natCode,

                            teamName: team.name,

                            teamLogo: team.logo

                        });

                    }

                });

            }

        }

    }



    function populateTransferMarket() {

        const container = document.getElementById('transferMarketResults');

        const nameFilter = document.getElementById('playerNameSearch').value.toLowerCase();

        const posFilter = document.getElementById('positionFilter').value;

        

        container.innerHTML = '';

        

        const filteredPlayers = allPlayers.filter(p => {

            if (!p || !p.name) return false;

            const nameMatch = p.name.toLowerCase().includes(nameFilter);

            const posMatch = posFilter ? p.position === posFilter : true;

            const isNotUserPlayer = !gameState.playerName || p.name !== gameState.playerName;

            return nameMatch && posMatch && isNotUserPlayer;

        });



        if (filteredPlayers.length === 0) {

            container.innerHTML = `<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nincs a keresésnek megfelelő játékos.</p>`;

            return;

        }



        filteredPlayers.slice(0, 50).forEach(player => {

            const natInfo = NATIONALITIES[player.nationality];

            const flagSrc = natInfo ? natInfo.flag : '';

            const playerCard = document.createElement('div');

            playerCard.className = 'transfer-player-card';

            

            playerCard.innerHTML = `

                <div class="player-card-header">

                    <img src="${flagSrc}" class="player-nat-flag" alt="${player.nationality}">

                    <div class="player-card-name">

                        <strong>${player.name}</strong> (${player.position})

                        <div class="player-card-team">

                            <img src="${player.teamLogo}" alt="${player.teamName}">

                            <span>${player.teamName}</span>

                        </div>

                    </div>

                </div>

                <div class="player-card-body">

                    <span class="stat-rating"><i class="fas fa-star"></i> ${player.rating}</span>

                    <span>Kor: ${player.age}</span>

                    <span class="stat-value">${formatValue(player.value)}</span>

                </div>

                <div class="player-card-footer">

                    <button class="button offer-btn">Ajánlat</button>

                </div>

            `;

            

            playerCard.querySelector('.offer-btn').addEventListener('click', () => {

                showOfferModal(player);

            });

            

            container.appendChild(playerCard);

        });

    }



    function showOfferModal(player) {

        const overlay = document.getElementById('offerModalOverlay');

        const card = document.getElementById('offerModalCard');

        

        card.innerHTML = `

            <h3>Ajánlat a következő játékosért:</h3>

            <div class="offer-player-info">

                <img src="${player.teamLogo}" alt="${player.teamName}">

                <div>

                    <strong>${player.name}</strong>

                    <p>Érték: ${formatValue(player.value)}</p>

                </div>

            </div>

            <div class="offer-input-group">

                <label for="offerAmount">Ajánlatod (€)</label>

                <input type="number" id="offerAmount" value="${player.value}" step="100000">

            </div>

            <p id="offerError" class="error-message hidden">Nincs elég pénzed!</p>

            <div class="navigation-buttons">

                <button class="button prev-btn" id="cancelOfferBtn">Mégse</button>

                <button class="button next-btn" id="submitOfferBtn">Ajánlat elküldése</button>

            </div>

        `;

        

        overlay.classList.remove('hidden');



        document.getElementById('submitOfferBtn').addEventListener('click', () => {

            const amount = parseInt(document.getElementById('offerAmount').value, 10);

            if (gameState.money < amount) {

                document.getElementById('offerError').classList.remove('hidden');

                return;

            }

            

            if (amount >= player.value) {

                gameState.money -= amount;

                updateHeaderUI();

                initiatePlayerSwap(player); // ÚJ HÍVÁS

            } else {

                alert(`Az ajánlatodat elutasították. Túl alacsony.`);

            }

            overlay.classList.add('hidden');

        });



        document.getElementById('cancelOfferBtn').addEventListener('click', () => {

            overlay.classList.add('hidden');

        });

    }



    function main() {

        allSaves = loadAllSaves();

        displaySaveSlots();

        

        let progress = 0;

        const loadingBar = document.getElementById('loadingBar');

        const loadingScreen = document.getElementById('loadingScreen');

        

        setTimeout(() => {

            generateAllPlayers();

        }, 100);



        const loadingInterval = setInterval(() => {

            progress += 5;

            loadingBar.style.width = `${progress}%`;

            if (progress >= 100) {

                clearInterval(loadingInterval);

                loadingScreen.classList.add('fade-out');

                setTimeout(() => {

                    loadingScreen.classList.add('hidden');

                    showMainMenu();

                }, 500);

            }

        }, 50);

    }

    

    function updateUI() {

        if (!gameState || Object.keys(gameState).length === 0) return;

        updateHeaderUI();

        updateDashboardUI();

        updateLeagueTable();

        updateProfileUI();

        updateTransferUI();

        updateSquadScreen(); // Mindig frissítjük a csapatképernyőt is

        if (!document.getElementById('globalTransferScreen').classList.contains('hidden')) {

            populateTransferMarket();

        }

    }



    function showScreen(targetScreenId) {

        allScreens.forEach(screen => screen.classList.add('hidden'));

        const targetScreen = document.getElementById(targetScreenId);

        if (targetScreen) {

            targetScreen.classList.remove('hidden');

        }

        updateNavButtons(targetScreenId);



        if (targetScreenId === 'globalTransferScreen') {

            populateTransferMarket();

        }

         if (targetScreenId === 'squadScreen') {

            updateSquadScreen();

        }

    }



    const SAVE_KEY = 'footballCrazySaves';

    let gameState = {};

    let allSaves = [];

    let currentSaveId = null;



    const mainMenu = document.getElementById('mainMenu');

    const characterCreator = document.getElementById('characterCreator');

    const matchSimulatorOverlay = document.getElementById('matchSimulatorOverlay');

    const matchGameOverlay = document.getElementById('matchGameOverlay');

    const matchResultOverlay = document.getElementById('matchResultOverlay');

    const canvas = document.getElementById('gameCanvas');

    const ctx = canvas.getContext('2d');

    const allScreens = document.querySelectorAll('.screen');

    const allNavButtons = document.querySelectorAll('.nav-btn');



    let gameLoop;

    let player, ball, opponents, teammates, keys, homeGoal;

    let currentMatchData;

    let simulationInterval;

    let miniGameActive = false;

    let isPaused = false;

    let opponentTeamColor = '#e74c3c';

    let selectedLeagueName = null;

    let selectedNationality = 'hu';

    let currentOpponentStrength = 70; 

    const PLAYER_BASE_SPEED = 3.5;

    

    let displayedCountry = null;

    let displayedLeagueName = null;



    function getLeagueData(leagueName) {

        for (const country in LEAGUES) {

            if (LEAGUES[country][leagueName]) {

                return { country, ...LEAGUES[country][leagueName] };

            }

        }

        return null;

    }

    

    function getCountryLeagues(countryName) {

        return LEAGUES[countryName] ? Object.keys(LEAGUES[countryName]) : [];

    }

    

    function getTeamData(teamName) {

        for (const country in LEAGUES) {

            for (const leagueName in LEAGUES[country]) {

                const team = LEAGUES[country][leagueName].teams.find(t => t.name === teamName);

                if (team) return team;

            }

        }

        return null;

    }



    function loadAllSaves() {

        const savedData = localStorage.getItem(SAVE_KEY);

        return savedData ? JSON.parse(savedData) : [];

    }



    function saveAllSaves() {

        try {

            const gameIndex = allSaves.findIndex(save => save.id === currentSaveId);

            if (gameIndex !== -1) {

                allSaves[gameIndex] = gameState;

            }

            localStorage.setItem(SAVE_KEY, JSON.stringify(allSaves));

        } catch (e) {

            console.error("Hiba a játék mentésekor: ", e);

        }

    }

    

    function deleteSave(saveId) {

        allSaves = allSaves.filter(save => save.id !== saveId);

        saveAllSaves();

        displaySaveSlots();

    }



    function loadSelectedGame(saveId) {

        const selectedSave = allSaves.find(save => save.id === saveId);

        if (selectedSave) {

            currentSaveId = saveId;

            gameState = selectedSave;



            // Keret generálása, ha hiányzik (régi mentésekhez)

            if (!gameState.team.players || gameState.team.players.length === 0) {

                 generateRosterForTeam(gameState.team.name);

            }



            const leagueData = getLeagueData(gameState.leagueName);

            if (!leagueData) {

                console.error("A mentett játékhoz tartozó bajnokság nem található.");

                mainMenu.classList.remove('hidden');

                return;

            }

            const currentLeagueTeams = leagueData.teams;



            if (!gameState.schedule || gameState.schedule.length === 0 || gameState.currentMatchday >= gameState.schedule.length) {

                gameState.schedule = generateSchedule(currentLeagueTeams.map(t => t.name));

                gameState.currentMatchday = 0;

                gameState.league = currentLeagueTeams.map(t => ({ name: t.name, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 }));

                

                saveAllSaves();

            }

            showMainHub();

        }

    }

    function showMainMenu() {

        mainMenu.classList.remove('hidden');

        characterCreator.classList.add('hidden');

        document.getElementById('mainHub').classList.add('hidden');

        displaySaveSlots();

    }

    

    function displaySaveSlots() {

        const container = document.getElementById('saveSlotsContainer');

        container.innerHTML = allSaves.length === 0 ? '<p style="text-align: center; color: var(--text-muted);">Nincsenek mentett játékok.</p>' : '';



        allSaves.forEach(save => {

            const slot = document.createElement('div');

            slot.className = 'save-slot';

            slot.dataset.id = save.id;

            

            const teamData = getTeamData(save.team.name);

            const teamLogo = teamData ? teamData.logo : 'https://placehold.co/40x40/cccccc/000000?text=?';



            slot.innerHTML = `

                <div style="display: flex; align-items: center; gap: 1rem; text-align: left;">

                    <img src="${teamLogo}" alt="${save.team.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: contain;">

                    <div class="save-slot-info">

                        <h4>${save.playerName}</h4>

                        <p>${save.team.name} - ${save.leagueName}</p>

                    </div>

                </div>

                <button class="delete-save-btn" data-id="${save.id}">&times;</button>

            `;

            

            container.appendChild(slot);



            slot.addEventListener('click', (e) => {

                if (e.target.classList.contains('delete-save-btn')) return;

                const saveId = parseInt(e.currentTarget.dataset.id, 10);

                loadSelectedGame(saveId);

            });



            slot.querySelector('.delete-save-btn').addEventListener('click', (e) => {

                e.stopPropagation();

                const saveId = parseInt(e.currentTarget.dataset.id, 10);

                if (confirm(`Biztosan törölni szeretnéd a "${save.playerName}" nevű mentést?`)) {

                    deleteSave(saveId);

                }

            });

        });

    }



    function initializeCharacterCreator() {

        mainMenu.classList.add('hidden');

        characterCreator.classList.remove('hidden');

        

        const formCarousel = document.getElementById('formCarousel');

        const totalSteps = formCarousel.children.length;

        let currentStep = 0;

        const playerNameInput = document.getElementById('playerName');

        const leagueSelectGrid = document.getElementById('leagueSelectGrid');



        function updateCarousel() { formCarousel.style.transform = `translateX(-${currentStep * 100}%)`; }

        

        document.querySelectorAll('#characterCreator .next-btn').forEach(btn => btn.addEventListener('click', (e) => {

            e.stopPropagation();

            if (currentStep === 0 && playerNameInput.value.trim() === "") return;

            if (currentStep === 1 && selectedNationality === null) return;

            if (currentStep === 2 && selectedLeagueName === null) return;

            if (currentStep < totalSteps - 1) { 

                currentStep++;

                if (currentStep === 3) {

                    generateContractOffers();

                }

                updateCarousel();

            }

        }));

        

        document.querySelectorAll('#characterCreator .prev-btn').forEach(btn => btn.addEventListener('click', (e) => {

            e.stopPropagation();

            if (currentStep > 0) { currentStep--; updateCarousel(); }

        }));



        const nationalityOptions = document.getElementById('nationalityOptions');

        nationalityOptions.innerHTML = '';

        for (const code in NATIONALITIES) {

            const nation = NATIONALITIES[code];

            const optionDiv = document.createElement('div');

            optionDiv.className = 'option';

            optionDiv.dataset.value = code;

            optionDiv.innerHTML = `<img src="${nation.flag}" alt="${nation.name} zászló"><span>${nation.name}</span>`;

            nationalityOptions.appendChild(optionDiv);

        }



        const nationalitySelectBtn = document.getElementById('nationalitySelect');

        nationalitySelectBtn.addEventListener('click', (e) => {

            e.stopPropagation();

            nationalityOptions.classList.toggle('hidden');

        });

        document.addEventListener('click', () => { nationalityOptions.classList.add('hidden'); });

        nationalityOptions.addEventListener('click', (e) => {

            const option = e.target.closest('.option');

            if (option) {

                selectedNationality = option.dataset.value;

                const selectedOptionDisplay = document.querySelector('#nationalitySelect .selected-option');

                selectedOptionDisplay.innerHTML = `<img src="${NATIONALITIES[selectedNationality].flag}" alt="${NATIONALITIES[selectedNationality].name} zászló"><span>${NATIONALITIES[selectedNationality].name}</span>`;

                nationalityOptions.classList.add('hidden');

            }

        });



        leagueSelectGrid.innerHTML = '';

        for (const country in LEAGUES) {

            for (const leagueName in LEAGUES[country]) {

                if (LEAGUES[country][leagueName].tier === 1) {

                    const button = document.createElement('button');

                    button.className = 'league-select-btn';

                    button.textContent = leagueName;

                    button.dataset.league = leagueName;

                    button.addEventListener('click', () => {

                        document.querySelectorAll('.league-select-btn').forEach(b => b.classList.remove('active'));

                        button.classList.add('active');

                        selectedLeagueName = leagueName;

                    });

                    leagueSelectGrid.appendChild(button);

                }

            }

        }

    }



    function generateContractOffers() {

        const offersContainer = document.getElementById('contractOffersContainer');

        offersContainer.innerHTML = '';

        

        const leagueData = getLeagueData(selectedLeagueName);

        if (!leagueData) return;

        const leagueTeams = leagueData.teams;

        const smallTeams = leagueTeams.filter(t => t.strength <= 75);

        

        const offers = [];

        const chosenTeams = new Set();

        while (offers.length < 2 && chosenTeams.size < leagueTeams.length) {

            const teamPool = smallTeams.length >= 2 ? smallTeams : leagueTeams;

            const team = getRandomElement(teamPool);

            if (!chosenTeams.has(team.name)) {

                chosenTeams.add(team.name);

                offers.push(team);

            }

        }



        showOffers(offers);

    }

    

    function showOffers(offers) {

        const offersContainer = document.getElementById('contractOffersContainer');

        offers.forEach(team => {

            const teamOfferCard = document.createElement('div');

            teamOfferCard.className = 'contract-offer-card';

            teamOfferCard.innerHTML = `

                <img src="${team.logo}" alt="${team.name} logó">

                <h3>${team.name}</h3>

                <p><strong>Fizetés:</strong> €15.000 /hét</p>

                <button class="button submit-btn accept-offer-btn" data-team='${JSON.stringify(team)}'>Szerződés aláírása</button>

            `;

            offersContainer.appendChild(teamOfferCard);

        });



        document.querySelectorAll('.accept-offer-btn').forEach(button => {

            button.addEventListener('click', (e) => {

                const team = JSON.parse(e.target.dataset.team);

                startNewGame(team);

            });

        });

    }



    function generateRosterForTeam(teamName) {

        const teamPlayers = allPlayers.filter(p => p.teamName === teamName);

        

        const positions = { 'K': [], 'V': [], 'KP': [], 'CS': [] };

        teamPlayers.forEach(p => {

            if (positions[p.position]) {

                positions[p.position].push(p);

            }

        });



        const roster = [

            ...positions['K'].slice(0, 2),

            ...positions['V'].slice(0, 5),

            ...positions['KP'].slice(0, 5),

            ...positions['CS'].slice(0, 4)

        ];



        gameState.team.players = roster;



        // Add the user's player to the roster

        const userPlayer = {

            id: 'user_player',

            name: gameState.playerName,

            position: 'CS', // Default position, can be changed later

            age: gameState.age,

            rating: gameState.rating,

            teamName: gameState.team.name,

            isUser: true

        };

        

        // Replace a forward if possible, otherwise a midfielder

        const fwds = gameState.team.players.filter(p => p.position === 'CS');

        if (fwds.length > 0) {

            const playerToReplaceIndex = gameState.team.players.findIndex(p => p.id === fwds[0].id);

            gameState.team.players[playerToReplaceIndex] = userPlayer;

        } else {

            const mids = gameState.team.players.filter(p => p.position === 'KP');

            if(mids.length > 0) {

                const playerToReplaceIndex = gameState.team.players.findIndex(p => p.id === mids[0].id);

                gameState.team.players[playerToReplaceIndex] = userPlayer;

            } else {

                 gameState.team.players.push(userPlayer);

            }

        }

    }



    function startNewGame(chosenTeam) {

        const leagueData = getLeagueData(selectedLeagueName);

        const leagueTeams = leagueData.teams;

        

        gameState = {

            id: Date.now(),

            playerName: document.getElementById('playerName').value || "Játékos",

            age: 17,

            nationality: selectedNationality,

            leagueName: selectedLeagueName,

            rating: 60,

            team: chosenTeam, // This includes name, logo, strength, but NOT players yet

            money: 250000, 

            salary: 15000, 

            goals: 0, 

            assists: 0, 

            matchesPlayed: 0, 

            trophies: [],

            clubHistory: [{ name: chosenTeam.name, year: new Date().getFullYear() + '-' }],

            league: leagueTeams.map(t => ({ name: t.name, played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 })),

            currentMatchday: 0,

            jerseyNumber: Math.floor(Math.random() * 98) + 1,

            schedule: generateSchedule(leagueTeams.map(t => t.name)),

            transferOffers: [],

            coins: 10

        };



        generateRosterForTeam(chosenTeam.name);

        

        currentSaveId = gameState.id;

        allSaves.push(gameState);

        saveAllSaves();



        characterCreator.classList.add('hidden');

        showMainHub();

    }



    // --- MECCS LOGIKA ---

    function playNextMatch() {

        if (!gameState.schedule || gameState.currentMatchday >= gameState.schedule.length) {

            endSeason();

            return;

        }

        startMatchSimulator();

    }

    

    function startMatchSimulator() {

        const leagueData = getLeagueData(gameState.leagueName);

        if (!leagueData) return;

        const leagueTeams = leagueData.teams;

        

        const fixture = gameState.schedule[gameState.currentMatchday].find(f => f.home === gameState.team.name || f.away === gameState.team.name);

        if (!fixture) { 

            const allFixtures = gameState.schedule[gameState.currentMatchday];

            allFixtures.forEach(f => processMatchResult(simulateOtherMatch(f.home, f.away)));

            gameState.currentMatchday++;

            saveAllSaves();

            updateUI();

            return;

        }

        

        const homeTeam = leagueTeams.find(t => t.name === fixture.home);

        const awayTeam = leagueTeams.find(t => t.name === fixture.away);



        if (!currentMatchData || currentMatchData.fixture.home !== fixture.home) {

            currentMatchData = { 

                fixture, 

                time: 0, 

                homeScore: 0, 

                awayScore: 0, 

                playerGoals: 0, 

                playerAssists: 0, 

                events: [{time: 0, comment: "Kezdőrúgás!", icon: "fa-futbol"}],

                halfTimeReached: false 

            };

        }

        

        document.getElementById('simHomeName').textContent = homeTeam.name;

        document.getElementById('simAwayName').textContent = awayTeam.name;

        document.getElementById('bannerPlayerName').textContent = gameState.playerName;

        updateSimulatorUI();

        

        document.getElementById('mainHub').classList.add('hidden');

        matchSimulatorOverlay.classList.remove('hidden');

        

        isPaused = false;

        document.getElementById('sim-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';

        runSimulation();

    }



    function runSimulation() {

        simulationInterval = setInterval(() => {

            if (isPaused) return;

            currentMatchData.time += 2;

            

            if (currentMatchData.time >= 45 && !currentMatchData.halfTimeReached) {

                currentMatchData.halfTimeReached = true;

                clearInterval(simulationInterval);

                addMatchEvent("FÉLIDŐ! Rövid szünet után folytatódik a mérkőzés.", "fa-coffee");

                

                document.getElementById('half-time-banner').classList.remove('hidden');



                setTimeout(() => {

                    document.getElementById('half-time-banner').classList.add('hidden');

                    runSimulation();

                }, 4000);

                return;

            }

            

            const leagueTeams = getLeagueData(gameState.leagueName).teams;

            const homeTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.home);

            const awayTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.away);

            

            const playerTeam = gameState.team;

            const playerIsHome = gameState.team.name === homeTeam.name;

            const opponentTeam = playerIsHome ? awayTeam : homeTeam;

            

            const playerTeamStrength = playerTeam.strength;

            const opponentStrength = opponentTeam.strength;

            const chanceModifier = (playerTeamStrength - opponentStrength) / 250;



            if (Math.random() < 0.15 + chanceModifier) {

                clearInterval(simulationInterval);

                addMatchEvent("HELYZET! A csapatod támad, most rajtad a sor!", "fa-star");

                document.getElementById('pitch-enter-banner').classList.remove('hidden');

                setTimeout(() => {

                    matchSimulatorOverlay.classList.add('hidden');

                    document.getElementById('pitch-enter-banner').classList.add('hidden');

                    startMatchGame(opponentStrength);

                }, 2500);

                return;

            } 

            

            if (Math.random() < 0.04 - chanceModifier) {

                 if(playerIsHome) currentMatchData.awayScore++; else currentMatchData.homeScore++;

                 addMatchEvent(`GÓL! Az ellenfél szerzett vezetést! (${opponentTeam.name})`, "fa-futbol");

            } else if (Math.random() < 0.2) {

                addMatchEvent(getRandomCommentary(), "fa-running");

            }



            updateSimulatorUI();



            if (currentMatchData.time >= 90) {

                endMatchGame();

            }

        }, 1000);

    }

    

    function togglePause() {

        isPaused = !isPaused;

        const pauseBtn = document.getElementById('sim-pause-btn');

        pauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';

    }



    function updateSimulatorUI() {

        document.getElementById('simScore').textContent = `${currentMatchData.homeScore} - ${currentMatchData.awayScore}`;

        document.getElementById('simTime').textContent = `${String(Math.floor(currentMatchData.time)).padStart(2, '0')}:00`;

        const timeline = document.getElementById('commentary-timeline');

        timeline.innerHTML = '';

        currentMatchData.events.forEach(event => {

            const eventDiv = document.createElement('div');

            eventDiv.className = `event-item ${event.icon.replace('fa-', '')}`;

            eventDiv.innerHTML = `<div class="event-icon"><i class="fas ${event.icon}"></i></div>

                                        <div class="event-text"><span class="time">${String(event.time).padStart(2, '0')}'</span> <span class="comment">${event.comment}</span></div>`;

            timeline.appendChild(eventDiv);

        });

        timeline.scrollTop = 0;

    }



    function addMatchEvent(comment, icon) {

        currentMatchData.events.unshift({time: Math.floor(currentMatchData.time), comment, icon});

        updateSimulatorUI();

    }

    

    function getRandomCommentary() {

        const comments = ["A középpályán folyik a játék.", "Szép passz a szélen.", "Bedobás következik.", "Az ellenfél birtokolja a labdát.", "Szabadrúgás a félpályánál."];

        return comments[Math.floor(Math.random() * comments.length)];

    }



    function updateScoreboardUI() {

        const leagueTeams = getLeagueData(gameState.leagueName).teams;

        const homeTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.home);

        const awayTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.away);



        document.getElementById('gameHomeName').textContent = homeTeam.name.substring(0,3).toUpperCase();

        document.getElementById('gameAwayName').textContent = awayTeam.name.substring(0,3).toUpperCase();

        document.getElementById('gameScore').textContent = `${currentMatchData.homeScore} - ${currentMatchData.awayScore}`;



        const homeP = document.getElementById('homeProgress');

        const awayP = document.getElementById('awayProgress');

        const homeScore = currentMatchData.homeScore;

        const awayScore = currentMatchData.awayScore;

        const totalScore = homeScore + awayScore;

        

        let homeFlex = 0.5;

        if (totalScore > 0) {

            homeFlex = homeScore / totalScore;

        }

        

        homeFlex = Math.max(0.05, Math.min(0.95, homeFlex));



        homeP.style.flex = homeFlex;

        awayP.style.flex = 1 - homeFlex;

    }



    function startMatchGame(opponentStrength) {

        miniGameActive = true;

        currentOpponentStrength = opponentStrength;

        matchGameOverlay.classList.remove('hidden');

        resizeCanvas();



        const leagueTeams = getLeagueData(gameState.leagueName).teams;

        const homeTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.home);

        const awayTeam = leagueTeams.find(t => t.name === currentMatchData.fixture.away);

        

        const playerIsHome = gameState.team.name === homeTeam.name;

        opponentTeamColor = playerIsHome ? awayTeam.color : homeTeam.color;



        updateScoreboardUI();



        keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, ' ': false, 'c': false };



        const startX = canvas.width * (0.25 + Math.random() * 0.5);

        player = { x: startX, y: canvas.height * 0.85, speed: PLAYER_BASE_SPEED, isPlayer: true, radius: 15, possessionRadius: 25 };

        ball = { x: startX, y: canvas.height * 0.65, radius: 8, speedX: 0, speedY: 0, friction: 0.98, controlledBy: null, shotBy: null, passedBy: null };

        

        homeGoal = { x: canvas.width / 2, y: 15, width: canvas.width * 0.3, height: 20 };

        

        teammates = [

            { x: canvas.width * 0.25, y: canvas.height * 0.45, speed: 2.8, radius: 15, jerseyNumber: 8, decisionTimeout: 0 },

            { x: canvas.width * 0.75, y: canvas.height * 0.45, speed: 2.8, radius: 15, jerseyNumber: 11, decisionTimeout: 0 }

        ];



        const defenderBaseSpeed = 1.6;

        const keeperBaseSpeed = 1.5;

        const defenderSpeed = defenderBaseSpeed + ((opponentStrength - 60) / 40) * 1.0;

        const keeperSpeed = keeperBaseSpeed + ((opponentStrength - 60) / 40) * 0.8;



        opponents = [

            { x: canvas.width / 2, y: 70, speed: keeperSpeed, radius: 16, type: 'goalkeeper', jerseyNumber: 1, isActive: false },

            { x: canvas.width * 0.35, y: 220, speed: defenderSpeed, radius: 15, type: 'defender', jerseyNumber: 4, isActive: false },

            { x: canvas.width * 0.65, y: 220, speed: defenderSpeed, radius: 15, type: 'defender', jerseyNumber: 5, isActive: false }

        ];



        setTimeout(() => {

            if (opponents) { 

                opponents.forEach(o => o.isActive = true);

            }

        }, 1200); 

        

        document.addEventListener('keydown', handleKeyDown);

        document.addEventListener('keyup', handleKeyUp);

        setupMobileControls();



        gameLoop = requestAnimationFrame(updateGame);

    }

    

    function handleTackleAndEnd() {

        let tackler = opponents[0];

        let minDist = Infinity;

        opponents.forEach(opp => {

            const dist = Math.hypot(opp.x - ball.x, opp.y - ball.y);

            if (dist < minDist) {

                minDist = dist;

                tackler = opp;

            }

        });

        

        ball.controlledBy = null;

        const angleAwayFromGoal = Math.atan2(canvas.height - tackler.y, (canvas.width / 2) - tackler.x);

        ball.speedX = Math.cos(angleAwayFromGoal) * 15;

        ball.speedY = Math.sin(angleAwayFromGoal) * 15;



        setTimeout(() => {

            endMatchAction(false, 'tackle');

        }, 1200);

    }



    function endMatchAction(isGoal, reason = 'tackle') {

        if (!miniGameActive) return;

        

        if (reason === 'tackle_animation') {

             handleTackleAndEnd();

             return;

        }



        miniGameActive = false;

        cancelAnimationFrame(gameLoop);

        document.removeEventListener('keydown', handleKeyDown);

        document.removeEventListener('keyup', handleKeyUp);

        removeMobileControls();



        const playerIsHome = gameState.team.name === currentMatchData.fixture.home;

        let eventMessage = "";

        let eventIcon = "fa-times-circle";



        if (isGoal) {

            if(playerIsHome) currentMatchData.homeScore++; else currentMatchData.awayScore++;



            if (ball.shotBy && ball.shotBy.isPlayer) {

                currentMatchData.playerGoals++;

                eventMessage = `GÓÓÓÓL! Fantasztikus befejezés! (${gameState.playerName})`;

            } else {

                const scorer = ball.shotBy;

                eventMessage = `GÓL! Szép csapatmunka! (${scorer ? `${scorer.jerseyNumber} szerezte a gólt!` : 'A csapatod betalált!'})`;

                if (ball.passedBy && ball.passedBy.isPlayer) {

                    currentMatchData.playerAssists++;

                }

            }

            eventIcon = "fa-futbol";

        } else {

            switch(reason) {

                case 'out_of_bounds':

                    eventMessage = "A labda elhagyta a játékteret. Elhibázott támadás.";

                    break;

                case 'tackle':

                default:

                    eventMessage = "Szereltek! Az ellenfélhez került a labda.";

                    break;

            }

        }

        

        ball.shotBy = null;

        ball.passedBy = null;



        addMatchEvent(eventMessage, eventIcon);

        

        updateScoreboardUI();

        matchGameOverlay.classList.add('hidden');

        matchSimulatorOverlay.classList.remove('hidden');

        updateSimulatorUI();

        

        setTimeout(() => {

            if (currentMatchData.time < 90) {

                runSimulation();

            } else {

                endMatchGame();

            }

        }, 1500);

    }



    function endMatchGame() {

        clearInterval(simulationInterval);

        addMatchEvent("VÉGE A MÉRKŐZÉSNEK!", "fa-stopwatch");



        setTimeout(() => {

            matchSimulatorOverlay.classList.add('hidden');

            const finalResult = { ...currentMatchData, homeName: currentMatchData.fixture.home, awayName: currentMatchData.fixture.away };

            processMatchResult(finalResult);

            

            const allFixtures = gameState.schedule[gameState.currentMatchday];

            const otherFixtures = allFixtures.filter(f => f.home !== gameState.team.name && f.away !== gameState.team.name);

            otherFixtures.forEach(fixture => { processMatchResult(simulateOtherMatch(fixture.home, fixture.away)); });



            gameState.currentMatchday++;

            checkTransferOffers();

            

            saveAllSaves();



            showMatchResult(finalResult);

            currentMatchData = null;

        }, 2000);

    }



    function processMatchResult(result) {

        const homeTeam = gameState.league.find(t => t.name === result.homeName);

        const awayTeam = gameState.league.find(t => t.name === result.awayName);

        if (!homeTeam || !awayTeam) return;



        homeTeam.played++; awayTeam.played++;

        homeTeam.gf += result.homeScore; homeTeam.ga += result.awayScore;

        awayTeam.gf += result.awayScore; awayTeam.ga += result.homeScore;

        homeTeam.gd = homeTeam.gf - homeTeam.ga;

        awayTeam.gd = awayTeam.gf - awayTeam.ga;



        if (result.homeScore > result.awayScore) { homeTeam.wins++; awayTeam.losses++; homeTeam.points += 3; } 

        else if (result.awayScore > result.homeScore) { awayTeam.wins++; homeTeam.losses++; awayTeam.points += 3; } 

        else { homeTeam.draws++; awayTeam.draws++; homeTeam.points++; awayTeam.points++; }

    }



    function showMatchResult(result) {

        const leagueTeams = getLeagueData(gameState.leagueName).teams;

        document.getElementById('resultHomeLogo').src = leagueTeams.find(t => t.name === result.homeName).logo || '';

        document.getElementById('resultHomeName').textContent = result.homeName;

        document.getElementById('resultAwayLogo').src = leagueTeams.find(t => t.name === result.awayName).logo || '';

        document.getElementById('resultAwayName').textContent = result.awayName;

        document.getElementById('resultScore').textContent = `${result.homeScore} - ${result.awayScore}`;

        

        let bonus = 0;

        const playerTeamWon = (gameState.team.name === result.homeName && result.homeScore > result.awayScore) || (gameState.team.name === result.awayName && result.awayScore > result.homeScore);

        if (playerTeamWon) bonus += 20000;

        if (result.homeScore === result.awayScore) bonus += 5000;

        bonus += result.playerGoals * 10000;

        bonus += result.playerAssists * 5000;

        gameState.money += (gameState.salary || 0) + bonus;

        gameState.goals += result.playerGoals;

        gameState.assists += result.playerAssists;

        gameState.matchesPlayed++;

        

        document.getElementById('resultPlayerPerformance').textContent = `Gólok: ${result.playerGoals}, Gólpasszok: ${result.playerAssists}`;

        document.getElementById('resultEarnings').textContent = `Fizetés: €${(gameState.salary || 0).toLocaleString()}, Bónusz: €${bonus.toLocaleString()}`;

        matchResultOverlay.classList.remove('hidden');

    }

    

    function simulateOtherMatch(homeName, awayName) {

        const leagueTeams = getLeagueData(gameState.leagueName).teams;

        const homeTeam = leagueTeams.find(t => t.name === homeName);

        const awayTeam = leagueTeams.find(t => t.name === awayName);

        if (!homeTeam || !awayTeam) {

            return { homeName, awayName, homeScore: 0, awayScore: 0, playerGoals: 0 };

        }

        const homeAdvantage = 0.15;

        const homeScore = Math.floor(Math.random() * (homeTeam.strength / 28 + homeAdvantage));

        const awayScore = Math.floor(Math.random() * (awayTeam.strength / 28));

        return { homeName, awayName, homeScore, awayScore, playerGoals: 0 };

    }

    

    function endSeason() {

        alert("A szezon véget ért!");

        const leagueTeams = getLeagueData(gameState.leagueName).teams;

        gameState.age++;

        gameState.schedule = generateSchedule(leagueTeams.map(t => t.name));

        gameState.currentMatchday = 0;

        gameState.league.forEach(team => { Object.assign(team, { played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, gd: 0, points: 0 }); });

        

        saveAllSaves();



        showMainHub();

    }



    function checkTransferOffers() {

        const playerRating = parseInt(gameState.rating);

        const playerGoals = gameState.goals;

        const playerTeamStrength = gameState.team.strength;

        const leagueTeams = getLeagueData(gameState.leagueName).teams;



        const offerChance = Math.max(0, (playerRating - 70) * 0.05 + (playerGoals * 0.01));

        if (Math.random() > offerChance) return;



        const availableTeams = leagueTeams.filter(t => t.strength > playerTeamStrength + 5);

        if (availableTeams.length === 0) return;



        const offerTeam = getRandomElement(availableTeams);

        const transferFee = Math.round(Math.random() * (playerRating * 100000) + 1000000);

        const salary = Math.round(Math.random() * (playerRating * 5000) + 20000);

        

        const offer = {

            teamName: offerTeam.name,

            fee: transferFee,

            salary: salary,

            teamLogo: offerTeam.logo

        };

        

        gameState.transferOffers.push(offer);

        updateTransferUI();

    }

    

    function updateTransferUI() {

        const offersContainer = document.getElementById('transferOffers');

        offersContainer.innerHTML = '';

        if (!gameState.transferOffers || gameState.transferOffers.length === 0) {

            offersContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted);">Jelenleg nincsenek ajánlatok.</p>`;

            return;

        }



        gameState.transferOffers.forEach((offer, index) => {

            const offerDiv = document.createElement('div');

            offerDiv.className = 'dashboard-card';

            offerDiv.style.marginBottom = '1rem';

            offerDiv.innerHTML = `

                <h3>${offer.teamName} ajánlata</h3>

                <p><strong>Átigazolási díj:</strong> €${offer.fee.toLocaleString()}</p>

                <p><strong>Heti fizetés:</strong> €${offer.salary.toLocaleString()}</p>

                <div class="navigation-buttons">

                    <button class="button" data-index="${index}" data-action="accept">Elfogad</button>

                    <button class="button prev-btn" data-index="${index}" data-action="reject">Elutasít</button>

                </div>

            `;

            offersContainer.appendChild(offerDiv);

        });

        

        offersContainer.addEventListener('click', (e) => {

            const target = e.target.closest('button');

            if(!target) return;



            const action = target.dataset.action;

            const index = parseInt(target.dataset.index, 10);

            if (!action || isNaN(index)) return;



            const offer = gameState.transferOffers[index];

            if (action === 'accept') {

                gameState.money += offer.fee;

                gameState.salary = offer.salary;

                const newTeamData = getTeamData(offer.teamName);

                gameState.team.name = newTeamData.name;

                gameState.team.logo = newTeamData.logo;

                gameState.team.strength = newTeamData.strength;

                gameState.team.color = newTeamData.color;



                generateRosterForTeam(newTeamData.name);

                

                gameState.clubHistory.push({ name: gameState.team.name, year: '2025-' });

                gameState.transferOffers = [];

                gameState.goals = 0;

                gameState.assists = 0;

                gameState.matchesPlayed = 0;

                saveAllSaves();

                showMainHub();

            } else if (action === 'reject') {

                gameState.transferOffers.splice(index, 1);

                saveAllSaves();

                updateTransferUI();

            }

        });

    }



    // --- JÁTÉK LOGIKA ---

    function handleKeyDown(e) { keys[e.key] = true; }

    function handleKeyUp(e) { keys[e.key] = false; }

    function updateGame() {if(!miniGameActive) return;let moveX = 0, moveY = 0;if (keys.ArrowUp) moveY -= 1;if (keys.ArrowDown) moveY += 1;if (keys.ArrowLeft) moveX -= 1;if (keys.ArrowRight) moveX += 1;if (moveX !== 0 || moveY !== 0) {const angle = Math.atan2(moveY, moveX);player.x += Math.cos(angle) * player.speed;player.y += Math.sin(angle) * player.speed;}player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));if (ball.controlledBy === null) {const distToPlayer = Math.hypot(player.x - ball.x, player.y - ball.y);if (distToPlayer < player.possessionRadius) { ball.controlledBy = player; }teammates.forEach(tm => {const distToTm = Math.hypot(tm.x - ball.x, tm.y - ball.y);if (distToTm < tm.radius + ball.radius + 5) { ball.controlledBy = tm; tm.decisionTimeout = 90; }});}if (ball.controlledBy === player) {let targetX = player.x;let targetY = player.y;const dribbleDistance = 35;let hasMovement = keys.ArrowUp || keys.ArrowDown || keys.ArrowLeft || keys.ArrowRight;if (hasMovement) {let moveAngle = Math.atan2((keys.ArrowDown ? 1 : 0) - (keys.ArrowUp ? 1 : 0),(keys.ArrowRight ? 1 : 0) - (keys.ArrowLeft ? 1 : 0));targetX = player.x + Math.cos(moveAngle) * dribbleDistance;targetY = player.y + Math.sin(moveAngle) * dribbleDistance;}ball.x += (targetX - ball.x) * 0.2;ball.y += (targetY - ball.y) * 0.2;if (keys[' ']) {ball.controlledBy = null;ball.shotBy = player;ball.passedBy = null; const angle = Math.atan2((homeGoal.y + homeGoal.height / 2) - player.y, homeGoal.x - player.x);ball.speedX = Math.cos(angle) * 20;ball.speedY = Math.sin(angle) * 20;keys[' '] = false;} else if (keys['c']) {ball.controlledBy = null;ball.passedBy = player;let closestTm = null, minDist = Infinity;teammates.forEach(tm => {const dist = Math.hypot(player.x - tm.x, player.y - tm.y);if (dist < minDist) { minDist = dist; closestTm = tm; }});if (closestTm) {const angle = Math.atan2(closestTm.y - player.y, closestTm.x - player.x);ball.speedX = Math.cos(angle) * 15;ball.speedY = Math.sin(angle) * 15;}keys['c'] = false;}} else if (ball.controlledBy && !ball.controlledBy.isPlayer) {let tm = ball.controlledBy;tm.decisionTimeout--;const angleToGoal = Math.atan2(homeGoal.y - tm.y, homeGoal.x - tm.x);tm.x += Math.cos(angleToGoal) * (tm.speed * 0.8);tm.y += Math.sin(angleToGoal) * (tm.speed * 0.8);ball.x += (tm.x - ball.x) * 0.3; ball.y += (tm.y - ball.y) * 0.3;if (tm.decisionTimeout <= 0) {ball.controlledBy = null;if (tm.y < canvas.height / 2 && Math.random() < 0.5) {ball.shotBy = tm;const angle = Math.atan2((homeGoal.y + homeGoal.height / 2) - tm.y, homeGoal.x - tm.x);ball.speedX = Math.cos(angle) * 18;ball.speedY = Math.sin(angle) * 18;} else {ball.passedBy = tm;const angle = Math.atan2(player.y - tm.y, player.x - tm.x);ball.speedX = Math.cos(angle) * 15;ball.speedY = Math.sin(angle) * 15;}}}ball.x += ball.speedX; ball.y += ball.speedY;ball.speedX *= ball.friction; ball.speedY *= ball.friction;teammates.forEach(tm => {if (ball.controlledBy !== tm) {const idealX = player.x + (tm.jerseyNumber === 8 ? -120 : 120);const idealY = player.y - 90;const angle = Math.atan2(idealY - tm.y, idealX - tm.x);tm.x += Math.cos(angle) * (tm.speed * 0.3);tm.y += Math.sin(angle) * (tm.speed * 0.3);}});opponents.forEach(opp => {if (!opp.isActive) return;if (opp.type === 'defender') {const target = ball.controlledBy ? ball.controlledBy : ball;const angleToTarget = Math.atan2(target.y - opp.y, target.x - opp.x);opp.x += Math.cos(angleToTarget) * opp.speed;opp.y += Math.sin(angleToTarget) * opp.speed;}});const keeper = opponents.find(o => o.type === 'goalkeeper');if(keeper && keeper.isActive) {const keeperAgility = 0.08 + ((currentOpponentStrength - 60) / 40) * 0.06;const idealY = homeGoal.y + homeGoal.height + keeper.radius;keeper.x += (ball.x - keeper.x) * keeperAgility;keeper.x = Math.max(homeGoal.x - homeGoal.width / 2, Math.min(homeGoal.x + homeGoal.width / 2, keeper.x));keeper.y += (idealY - keeper.y) * 0.1;const distToBall = Math.hypot(ball.x - keeper.x, ball.y - keeper.y);const ballSpeed = Math.hypot(ball.speedX, ball.speedY);if (distToBall < keeper.radius + ball.radius && ballSpeed > 5) {const saveChance = 0.5 + ((currentOpponentStrength - 50) / 50) * 0.45;if (Math.random() < saveChance) {ball.speedY *= -0.5;ball.speedX *= 0.5;ball.shotBy = null;}}}opponents.forEach(opp => {const distToPlayer = Math.hypot(player.x - opp.x, player.y - opp.y);if (ball.controlledBy === player && distToPlayer < player.radius + opp.radius) { endMatchAction(false, 'tackle_animation');}});if (ball.y < homeGoal.y + homeGoal.height && ball.y > homeGoal.y && ball.x > homeGoal.x - homeGoal.width / 2 && ball.x < homeGoal.x + homeGoal.width / 2) { endMatchAction(true, 'goal');}const sidelineMargin = 5;if (ball.x < sidelineMargin || ball.x > canvas.width - sidelineMargin || ball.y > canvas.height - sidelineMargin || ball.y < 0) {endMatchAction(false, 'out_of_bounds');}draw();gameLoop = requestAnimationFrame(updateGame);}

    function draw() {ctx.clearRect(0, 0, canvas.width, canvas.height);const grassStripes = 12;for (let i = 0; i < grassStripes; i++) {ctx.fillStyle = i % 2 === 0 ? '#1a511a' : '#1e5e1e';ctx.fillRect(0, i * canvas.height / grassStripes, canvas.width, canvas.height / grassStripes);}ctx.strokeStyle = 'rgba(255,255,255,0.7)';ctx.lineWidth = 2;ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);ctx.beginPath();ctx.moveTo(5, canvas.height/2);ctx.lineTo(canvas.width - 5, canvas.height/2);ctx.stroke();ctx.beginPath();ctx.arc(canvas.width / 2, canvas.height/2, 60, 0, 2*Math.PI);ctx.stroke();const penaltyBoxWidth = Math.min(400, canvas.width * 0.8);ctx.strokeRect((canvas.width - penaltyBoxWidth) / 2, 5, penaltyBoxWidth, 120);ctx.fillStyle = '#FFFFFF';ctx.fillRect(homeGoal.x - homeGoal.width/2 - 5, homeGoal.y - 15, 5, 25);ctx.fillRect(homeGoal.x + homeGoal.width/2, homeGoal.y - 15, 5, 25);ctx.fillRect(homeGoal.x - homeGoal.width/2 - 5, homeGoal.y - 15, homeGoal.width + 10, 5);const netSpacing = 5;ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';ctx.lineWidth = 1;for (let i = 0; i <= 20; i += netSpacing) {ctx.beginPath();ctx.moveTo(homeGoal.x - homeGoal.width / 2, homeGoal.y + i);ctx.lineTo(homeGoal.x + homeGoal.width / 2, homeGoal.y + i);ctx.stroke();}for (let i = -homeGoal.width / 2; i <= homeGoal.width / 2; i += netSpacing) {ctx.beginPath();ctx.moveTo(homeGoal.x + i, homeGoal.y);ctx.lineTo(homeGoal.x + i, homeGoal.y + 20);ctx.stroke();}drawBall(ball);opponents.forEach(drawPlayer);teammates.forEach(tm => drawPlayer(tm));drawPlayer(player);}

    function drawWithShadow(drawFunction) {ctx.save();ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';ctx.shadowBlur = 10;ctx.shadowOffsetY = 5;drawFunction();ctx.restore();}

    function drawBall(b) {drawWithShadow(() => {ctx.fillStyle = 'white';ctx.beginPath();ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);ctx.fill();ctx.strokeStyle = 'black';ctx.lineWidth = 1;ctx.stroke();});}

    function drawPlayer(entity) {drawWithShadow(() => {let teamColor = opponentTeamColor;if (entity.isPlayer || teammates.includes(entity)) {teamColor = gameState.team.color || '#3498db';} else if (entity.type === 'goalkeeper') {teamColor = '#333333';}ctx.fillStyle = 'white';ctx.beginPath();ctx.arc(entity.x, entity.y, entity.radius, 0, Math.PI * 2);ctx.fill();ctx.fillStyle = teamColor;ctx.beginPath();ctx.arc(entity.x, entity.y, entity.radius * 0.75, 0, Math.PI * 2);ctx.fill();ctx.fillStyle = teamColor.toLowerCase() === '#ffffff' ? 'black' : 'white';ctx.font = 'bold 12px Inter';ctx.textAlign = 'center';ctx.textBaseline = 'middle';const number = entity.isPlayer ? gameState.jerseyNumber : entity.jerseyNumber;ctx.fillText(number, entity.x, entity.y);if(entity.isPlayer) {if (ball.controlledBy !== player) {ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';ctx.lineWidth = 2;ctx.beginPath();ctx.arc(entity.x, entity.y, entity.possessionRadius, 0, Math.PI * 2);ctx.stroke();}ctx.beginPath();ctx.moveTo(entity.x, entity.y - entity.radius - 6);ctx.lineTo(entity.x - 7, entity.y - entity.radius - 14);ctx.lineTo(entity.x + 7, entity.y - entity.radius - 14);ctx.closePath();ctx.fillStyle = '#f1c40f';ctx.fill();}});}

    function resizeCanvas() {const parent = matchGameOverlay;canvas.width = parent.clientWidth;canvas.height = parent.clientHeight;if (homeGoal) { homeGoal.width = canvas.width * 0.4; homeGoal.x = canvas.width / 2;}}

    const joystickZone = document.getElementById('joystick-zone');const joystickHandle = document.getElementById('joystick-handle');const shootBtn = document.getElementById('shoot-btn');const passBtn = document.getElementById('pass-btn');let joystickStart = {};

    function handleJoystickStart(e) { e.preventDefault(); const touch = e.changedTouches[0]; joystickStart = { x: touch.clientX, y: touch.clientY }; }

    function handleJoystickMove(e) { e.preventDefault(); const touch = e.changedTouches[0]; updateJoystick({ x: touch.clientX, y: touch.clientY }); }

    function handleJoystickEnd(e) { e.preventDefault(); keys.ArrowUp = keys.ArrowDown = keys.ArrowLeft = keys.ArrowRight = false; joystickHandle.style.transform = `translate(0px, 0px)`;}

    function updateJoystick(current) {const dx = current.x - joystickStart.x;const dy = current.y - joystickStart.y;const angle = Math.atan2(dy, dx);const distance = Math.min(32, Math.sqrt(dx * dx + dy * dy));const x = distance * Math.cos(angle);const y = distance * Math.sin(angle);joystickHandle.style.transform = `translate(${x}px, ${y}px)`;const deadZone = 10;keys.ArrowUp = dy < -deadZone; keys.ArrowDown = dy > deadZone;keys.ArrowLeft = dx < -deadZone; keys.ArrowRight = dx > deadZone;}

    const handleShoot = (e) => { e.preventDefault(); keys[' '] = true; setTimeout(() => keys[' '] = false, 100); };

    const handlePass = (e) => { e.preventDefault(); keys['c'] = true; setTimeout(() => keys['c'] = false, 100); };

    function setupMobileControls() {joystickZone.addEventListener('touchstart', handleJoystickStart, {passive: false});joystickZone.addEventListener('touchmove', handleJoystickMove, {passive: false});joystickZone.addEventListener('touchend', handleJoystickEnd, {passive: false});shootBtn.addEventListener('touchstart', handleShoot, {passive: false});passBtn.addEventListener('touchstart', handlePass, {passive: false});}

    function removeMobileControls() {joystickZone.removeEventListener('touchstart', handleJoystickStart);joystickZone.removeEventListener('touchmove', handleJoystickMove);joystickZone.removeEventListener('touchend', handleJoystickEnd);shootBtn.removeEventListener('touchstart', handleShoot);passBtn.removeEventListener('touchstart', handlePass);}



    function showMainHub() {

        document.querySelectorAll('.overlay, .character-creator-container, .main-menu-container').forEach(o => o.classList.add('hidden'));

        document.getElementById('mainHub').classList.remove('hidden');

        

        const leagueData = getLeagueData(gameState.leagueName);

        displayedCountry = leagueData.country;

        displayedLeagueName = gameState.leagueName;

        

        updateUI();

    }

    

    function updateNavButtons(activeScreenId) { allNavButtons.forEach(btn => { btn.classList.toggle('active', btn.dataset.screen === activeScreenId); }); }

    

    function updateHeaderUI() { 

        document.getElementById('headerPlayerName').textContent = gameState.playerName; 

        document.getElementById('headerPlayerMoney').textContent = (gameState.money || 0).toLocaleString();

        document.getElementById('headerPlayerCoins').textContent = (gameState.coins || 0).toLocaleString();

    }

    function updateDashboardUI() {

        document.getElementById('hubPlayerName').textContent = gameState.playerName;

        document.getElementById('hubPlayerTeamName').textContent = gameState.team.name;

        document.getElementById('hubPlayerTeamLogo').src = gameState.team.logo;

        document.getElementById('hubPlayerRating').textContent = gameState.rating;

        document.getElementById('hubPlayerAge').textContent = gameState.age;

        

        if (gameState.schedule && gameState.schedule[gameState.currentMatchday]) { 

            const nextFixture = gameState.schedule[gameState.currentMatchday].find(f => f.home === gameState.team.name || f.away === gameState.team.name); 

            if(nextFixture) { 

                document.getElementById('hubNextOpponent').textContent = nextFixture.home === gameState.team.name ? nextFixture.away : nextFixture.home; 

            } else {

                 document.getElementById('hubNextOpponent').textContent = "Pihenőhét";

            }

        }

        

        const playerTeamRow = [...gameState.league].sort((a, b) => b.points - a.points || (b.gd - a.gd)).findIndex(t => t.name === gameState.team.name) + 1;

        document.getElementById('hubLeaguePosition').textContent = playerTeamRow > 0 ? `${playerTeamRow}.` : '-';

        document.getElementById('hubMatchday').textContent = `Forduló: ${gameState.currentMatchday} / ${gameState.schedule.length}`;

    }



    function updateSquadScreen() {

        if (!gameState || !gameState.team || !gameState.team.players) return;

        

        document.getElementById('squadTeamName').textContent = `${gameState.team.name} - Felállás`;



        const formation = {

            'goalkeeper': document.getElementById('formation-goalkeeper'),

            'defenders': document.getElementById('formation-defenders'),

            'midfielders': document.getElementById('formation-midfielders'),

            'forwards': document.getElementById('formation-forwards'),

        };



        // Clear previous players

        Object.values(formation).forEach(el => el.innerHTML = '');



        const playersByPos = { 'K': [], 'V': [], 'KP': [], 'CS': [] };

        gameState.team.players.forEach(p => {

             if(p && playersByPos[p.position]) {

                playersByPos[p.position].push(p);

             }

        });



        const appendPlayer = (player, container) => {

             const playerDiv = document.createElement('div');

             playerDiv.className = 'squad-player';

             if (player.isUser) {

                 playerDiv.classList.add('user-player');

             }

             playerDiv.innerHTML = `

                <div class="squad-player-jersey">

                    <i class="fas fa-tshirt"></i>

                    <span class="squad-player-rating">${player.rating}</span>

                </div>

                <div class="squad-player-name">${player.name.split(' ').pop()}</div>

             `;

             container.appendChild(playerDiv);

        };

        

        playersByPos['K'].forEach(p => appendPlayer(p, formation.goalkeeper));

        playersByPos['V'].forEach(p => appendPlayer(p, formation.defenders));

        playersByPos['KP'].forEach(p => appendPlayer(p, formation.midfielders));

        playersByPos['CS'].forEach(p => appendPlayer(p, formation.forwards));

    }



    function initiatePlayerSwap(newPlayer) {

        const overlay = document.getElementById('playerSwapModalOverlay');

        const card = document.getElementById('playerSwapModalCard');

        

        let rosterHTML = gameState.team.players.map((p, index) => {

            if (!p) return '';

            return `

                <div class="swap-player-row">

                    <span>(${p.position}) ${p.name}</span>

                    <span class="stat-rating"><i class="fas fa-star"></i> ${p.rating}</span>

                    <button class="button swap-btn" data-index="${index}">Csere</button>

                </div>

            `;

        }).join('');



        card.innerHTML = `

            <h3>Játékoscsere</h3>

            <p>Válaszd ki, kire cseréled az új igazolásodat:</p>

            <div class="offer-player-info" style="margin-bottom: 1rem;">

                <img src="${newPlayer.teamLogo}" alt="${newPlayer.teamName}">

                <div>

                    <strong>${newPlayer.name} (${newPlayer.position})</strong>

                    <p class="stat-rating"><i class="fas fa-star"></i> ${newPlayer.rating}</p>

                </div>

            </div>

            <div class="swap-roster-list">${rosterHTML}</div>

             <button class="button prev-btn" id="cancelSwapBtn" style="margin-top: 1rem;">Mégse</button>

        `;



        overlay.classList.remove('hidden');



        card.addEventListener('click', (e) => {

            if (e.target.classList.contains('swap-btn')) {

                const index = parseInt(e.target.dataset.index, 10);

                

                // Add correct team info to the new player

                newPlayer.teamName = gameState.team.name;

                newPlayer.teamLogo = gameState.team.logo;



                gameState.team.players[index] = newPlayer;



                saveAllSaves();

                updateSquadScreen();

                overlay.classList.add('hidden');

            }

             if (e.target.id === 'cancelSwapBtn') {

                overlay.classList.add('hidden');

            }

        });

    }

    

    function updateLeagueTable() {

        const tableBody = document.getElementById('leagueTableBody'); 

        const leagueTitle = document.getElementById('leagueTitle');

        if (!tableBody || !displayedLeagueName) return;



        leagueTitle.textContent = displayedLeagueName;

        

        const leagueData = getLeagueData(displayedLeagueName);

        if (!leagueData) return;

        const leagueTeams = leagueData.teams;



        tableBody.innerHTML = ''; 

        const leagueClone = [...(gameState.league || [])]; 

        leagueClone.sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf); 



        leagueClone.forEach((team, index) => { 

            const teamData = leagueTeams.find(t => t.name === team.name);

            const row = document.createElement('tr');

            row.className = 'league-table-row';

            if(team.name === gameState.team.name) row.classList.add('player-team'); 



            let posClass = '';

            if (index < 4) posClass = 'pos-cl';

            else if (index === 4) posClass = 'pos-el';

            else if (index >= leagueClone.length - 3) posClass = 'pos-rel';



            row.innerHTML = `

                <td><span class="position-indicator ${posClass}"></span>${index + 1}</td>

                <td class="team-name-cell"><img src="${teamData?.logo || ''}" class="team-logo-small">${team.name}</td>

                <td class="hide-on-mobile">${team.played}</td>

                <td class="hide-on-mobile">${team.wins}</td>

                <td class="hide-on-mobile">${team.draws}</td>

                <td class="hide-on-mobile">${team.losses}</td>

                <td>${team.gd}</td>

                <td><strong>${team.points}</strong></td>

            `;

            tableBody.appendChild(row);

        });

    }

    

    function updateProfileUI() { 

        document.getElementById('profilePlayerName').textContent = `${gameState.playerName} Profilja`;

        document.getElementById('profileGoals').textContent = gameState.goals || 0;

        document.getElementById('profileAssists').textContent = gameState.assists || 0;

        document.getElementById('profileMatches').textContent = gameState.matchesPlayed || 0;

        document.getElementById('profileTrophies').textContent = (gameState.trophies || []).length;

    }

    

    function generateSchedule(teamNames) {

        let teams = [...teamNames];

        if (teams.length % 2 !== 0) { teams.push(null); }

        const schedule = [];

        const numRounds = teams.length - 1;

        const numMatchesPerRound = teams.length / 2;



        for (let round = 0; round < numRounds; round++) {

            const roundMatches = [];

            for (let i = 0; i < numMatchesPerRound; i++) {

                const home = teams[i];

                const away = teams[teams.length - 1 - i];

                if (home && away) {

                    roundMatches.push({ home, away });

                }

            }

            schedule.push(roundMatches);

            teams.splice(1, 0, teams.pop());

        }



        const secondHalf = schedule.map(round => 

            round.map(({ home, away }) => ({ home: away, away: home }))

        );

        return [...schedule, ...secondHalf];

    }



    // Event Listenerek

    allNavButtons.forEach(button => button.addEventListener('click', () => showScreen(button.dataset.screen)));

    document.getElementById('profileBtn')?.addEventListener('click', () => showScreen('profileScreen'));

    document.getElementById('dashboardProfileCard')?.addEventListener('click', () => showScreen('squadScreen'));

    document.getElementById('playMatchBtn')?.addEventListener('click', playNextMatch);

    document.getElementById('matchResultContinueBtn')?.addEventListener('click', showMainHub);

    document.getElementById('sim-pause-btn')?.addEventListener('click', togglePause);

    document.getElementById('newGameBtn')?.addEventListener('click', initializeCharacterCreator);

    document.getElementById('playerNameSearch').addEventListener('input', populateTransferMarket);

    document.getElementById('positionFilter').addEventListener('change', populateTransferMarket);

    

    document.querySelectorAll('.stat-tab').forEach(tab => {

        tab.addEventListener('click', () => {

            document.querySelectorAll('.stat-tab').forEach(t => t.classList.remove('active'));

            tab.classList.add('active');

            

            document.querySelectorAll('.stats-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(tab.dataset.content).classList.remove('hidden');

        });

    });



    document.getElementById('leagueNavPrev').addEventListener('click', () => {

        const countryLeagues = getCountryLeagues(displayedCountry);

        const currentIndex = countryLeagues.indexOf(displayedLeagueName);

        if (currentIndex > 0) {

            displayedLeagueName = countryLeagues[currentIndex - 1];

            updateLeagueTable();

        }

    });



    document.getElementById('leagueNavNext').addEventListener('click', () => {

        const countryLeagues = getCountryLeagues(displayedCountry);

        const currentIndex = countryLeagues.indexOf(displayedLeagueName);

        if (currentIndex < countryLeagues.length - 1) {

            displayedLeagueName = countryLeagues[currentIndex + 1];

            updateLeagueTable();

        }

    });



    window.addEventListener('resize', resizeCanvas);

    

    main();

});

    </script>

</body>

</html>

